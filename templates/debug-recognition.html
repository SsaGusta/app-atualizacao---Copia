<!DOCTYPE html>
<html>
<head>
    <title>ğŸ” DiagnÃ³stico Detalhado - Problema de Reconhecimento</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .diagnostic-section { 
            border: 2px solid #007bff; 
            margin: 15px 0; 
            padding: 20px; 
            border-radius: 8px; 
            background: #f8f9fa;
        }
        .success { color: #28a745; font-weight: bold; }
        .error { color: #dc3545; font-weight: bold; }
        .warning { color: #ffc107; font-weight: bold; }
        .info { color: #17a2b8; font-weight: bold; }
        button { 
            padding: 12px 20px; 
            margin: 8px; 
            background: #007bff; 
            color: white; 
            border: none; 
            border-radius: 5px; 
            cursor: pointer; 
            font-size: 14px;
        }
        button:hover { background: #0056b3; }
        #output { 
            background: #ffffff; 
            padding: 20px; 
            border-radius: 8px; 
            margin-top: 20px; 
            white-space: pre-wrap; 
            border: 1px solid #ddd;
            max-height: 400px;
            overflow-y: auto;
        }
        .step { 
            background: #e9ecef; 
            padding: 10px; 
            margin: 5px 0; 
            border-left: 4px solid #007bff; 
        }
    </style>
</head>
<body>
    <h1>ğŸ” DiagnÃ³stico: Por que a letra A nÃ£o Ã© reconhecida?</h1>
    
    <div class="diagnostic-section">
        <h3>ğŸ“‹ Checklist de DiagnÃ³stico</h3>
        <button onclick="runFullDiagnostic()">ğŸš€ Executar DiagnÃ³stico Completo</button>
        <button onclick="testLetterA()">ğŸ”¤ Testar Especificamente Letra A</button>
        <button onclick="compareGestureQuality()">ğŸ“Š Comparar Qualidade dos Gestos</button>
        <button onclick="testRecognitionFlow()">ğŸ”„ Testar Fluxo de Reconhecimento</button>
    </div>
    
    <div class="diagnostic-section">
        <h3>ğŸ› ï¸ Testes EspecÃ­ficos</h3>
        <button onclick="checkGameIntegration()">ğŸ® Verificar IntegraÃ§Ã£o com Jogo</button>
        <button onclick="simulateGameRecognition()">ğŸ¯ Simular Reconhecimento no Jogo</button>
        <button onclick="checkThresholds()">âš–ï¸ Verificar Thresholds de ConfianÃ§a</button>
        <button onclick="debugLandmarks()">ğŸ“ Debug Landmarks</button>
    </div>
    
    <div id="output">Clique em um botÃ£o para iniciar o diagnÃ³stico...</div>

    <script src="/static/js/custom-gesture-recognizer.js"></script>
    <script>
        const output = document.getElementById('output');
        let recognizer = null;
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const emoji = type === 'success' ? 'âœ…' : type === 'error' ? 'âŒ' : type === 'warning' ? 'âš ï¸' : 'â„¹ï¸';
            output.textContent += `[${timestamp}] ${emoji} ${message}\n`;
            console.log(message);
        }
        
        function clearOutput() {
            output.textContent = '';
        }
        
        async function runFullDiagnostic() {
            clearOutput();
            log('ğŸ” INICIANDO DIAGNÃ“STICO COMPLETO...', 'info');
            log('='.repeat(50));
            
            // Passo 1: Verificar APIs
            log('ğŸ“¡ PASSO 1: Verificando APIs...', 'info');
            await checkAPIs();
            
            // Passo 2: Verificar gestos salvos
            log('ğŸ’¾ PASSO 2: Verificando gestos salvos...', 'info');
            await checkSavedGestures();
            
            // Passo 3: Verificar reconhecedor
            log('ğŸ¤– PASSO 3: Verificando reconhecedor...', 'info');
            await checkRecognizer();
            
            // Passo 4: Testar reconhecimento
            log('ğŸ¯ PASSO 4: Testando reconhecimento...', 'info');
            await testRecognition();
            
            log('='.repeat(50));
            log('ğŸ DIAGNÃ“STICO CONCLUÃDO!', 'success');
        }
        
        async function checkAPIs() {
            try {
                const response = await fetch('/api/get_gestures');
                if (response.ok) {
                    const gestures = await response.json();
                    log(`âœ… API funcionando - ${Object.keys(gestures).length} gestos encontrados`, 'success');
                    return gestures;
                } else {
                    log(`âŒ API com erro: ${response.status}`, 'error');
                    return null;
                }
            } catch (error) {
                log(`âŒ Erro na API: ${error.message}`, 'error');
                return null;
            }
        }
        
        async function checkSavedGestures() {
            const gestures = await checkAPIs();
            if (!gestures) return false;
            
            if (gestures.A) {
                log(`âœ… Letra A encontrada no banco!`, 'success');
                log(`   Qualidade: ${gestures.A.quality}%`, 'info');
                log(`   Criado em: ${gestures.A.created_at}`, 'info');
                log(`   Landmarks: ${gestures.A.landmarks.length} pontos`, 'info');
                return true;
            } else {
                log(`âŒ Letra A NÃƒO encontrada no banco!`, 'error');
                log(`ğŸ’¡ SoluÃ§Ã£o: Capture a letra A em /admin`, 'warning');
                return false;
            }
        }
        
        async function checkRecognizer() {
            try {
                recognizer = new CustomGestureRecognizer();
                
                // Aguardar carregamento
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                const stats = recognizer.getRecognitionStats();
                
                log(`ğŸ¤– Reconhecedor inicializado`, 'success');
                log(`   Gestos carregados: ${stats.gesturesLoaded}`, 'info');
                log(`   Total de gestos: ${stats.totalGestures}`, 'info');
                log(`   Letras disponÃ­veis: ${stats.availableLetters.join(', ')}`, 'info');
                
                if (stats.availableLetters.includes('A')) {
                    log(`âœ… Letra A disponÃ­vel no reconhecedor`, 'success');
                } else {
                    log(`âŒ Letra A NÃƒO disponÃ­vel no reconhecedor`, 'error');
                }
                
                return stats.availableLetters.includes('A');
                
            } catch (error) {
                log(`âŒ Erro no reconhecedor: ${error.message}`, 'error');
                return false;
            }
        }
        
        async function testRecognition() {
            if (!recognizer) {
                log(`âš ï¸ Reconhecedor nÃ£o inicializado`, 'warning');
                return;
            }
            
            // Buscar gesto salvo da letra A
            try {
                const response = await fetch('/api/get_gestures');
                const gestures = await response.json();
                
                if (!gestures.A) {
                    log(`âŒ Sem gesto da letra A para testar`, 'error');
                    return;
                }
                
                // Usar landmarks exatos do gesto salvo
                const savedLandmarks = gestures.A.landmarks;
                log(`ğŸ§ª Testando com landmarks salvos da letra A...`, 'info');
                
                const result = await recognizer.recognizeLetter(savedLandmarks);
                
                if (result) {
                    if (result.letter === 'A') {
                        log(`âœ… SUCESSO! Letra A reconhecida`, 'success');
                        log(`   ConfianÃ§a: ${(result.confidence * 100).toFixed(1)}%`, 'success');
                        log(`   EstÃ¡vel: ${result.stable}`, 'info');
                    } else {
                        log(`âŒ ERRO! Reconheceu '${result.letter}' ao invÃ©s de 'A'`, 'error');
                        log(`   ConfianÃ§a: ${(result.confidence * 100).toFixed(1)}%`, 'info');
                    }
                } else {
                    log(`âŒ FALHA! Nenhuma letra reconhecida`, 'error');
                    log(`ğŸ’¡ PossÃ­veis causas:`, 'warning');
                    log(`   - Threshold muito alto (atual: 75%)`, 'warning');
                    log(`   - Qualidade do gesto muito baixa`, 'warning');
                    log(`   - Erro no algoritmo de similaridade`, 'warning');
                }
                
            } catch (error) {
                log(`âŒ Erro no teste: ${error.message}`, 'error');
            }
        }
        
        async function testLetterA() {
            clearOutput();
            log('ğŸ”¤ TESTE ESPECÃFICO DA LETRA A', 'info');
            log('='.repeat(30));
            
            // Verificar se existe
            const response = await fetch('/api/get_gestures');
            const gestures = await response.json();
            
            if (!gestures.A) {
                log('âŒ Letra A nÃ£o foi capturada ainda!', 'error');
                log('ğŸ’¡ VÃ¡ para /admin e capture a letra A primeiro', 'warning');
                return;
            }
            
            const letterA = gestures.A;
            log(`âœ… Letra A encontrada:`, 'success');
            log(`   ğŸ“Š Qualidade: ${letterA.quality}%`, 'info');
            log(`   ğŸ“… Capturada em: ${new Date(letterA.created_at).toLocaleString()}`, 'info');
            log(`   ğŸ“ Landmarks: ${letterA.landmarks.length} pontos`, 'info');
            
            // Verificar qualidade dos landmarks
            let validPoints = 0;
            letterA.landmarks.forEach((point, i) => {
                if (point.x >= 0 && point.x <= 1 && point.y >= 0 && point.y <= 1) {
                    validPoints++;
                }
            });
            
            log(`   âœ… Pontos vÃ¡lidos: ${validPoints}/21 (${((validPoints/21)*100).toFixed(1)}%)`, 'info');
            
            if (validPoints < 21) {
                log(`âš ï¸ Alguns landmarks estÃ£o fora dos limites!`, 'warning');
            }
            
            // Testar reconhecimento direto via API
            log('ğŸ§ª Testando reconhecimento via API...', 'info');
            
            try {
                const recognizeResponse = await fetch('/api/recognize_gesture', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ landmarks: letterA.landmarks })
                });
                
                const recognizeResult = await recognizeResponse.json();
                
                if (recognizeResult.success) {
                    log(`âœ… API reconheceu: ${recognizeResult.result.letter}`, 'success');
                    log(`   ConfianÃ§a: ${(recognizeResult.result.confidence * 100).toFixed(1)}%`, 'info');
                } else {
                    log(`âŒ API falhou: ${recognizeResult.error || recognizeResult.message}`, 'error');
                }
                
            } catch (error) {
                log(`âŒ Erro na API: ${error.message}`, 'error');
            }
        }
        
        async function compareGestureQuality() {
            clearOutput();
            log('ğŸ“Š ANÃLISE DE QUALIDADE DOS GESTOS', 'info');
            log('='.repeat(35));
            
            const response = await fetch('/api/get_gestures');
            const gestures = await response.json();
            
            if (Object.keys(gestures).length === 0) {
                log('âŒ Nenhum gesto encontrado!', 'error');
                return;
            }
            
            const sortedGestures = Object.entries(gestures)
                .sort((a, b) => b[1].quality - a[1].quality);
            
            log('ğŸ“ˆ Gestos ordenados por qualidade:', 'info');
            
            sortedGestures.forEach(([letter, data], index) => {
                const status = data.quality >= 80 ? 'âœ…' : data.quality >= 60 ? 'âš ï¸' : 'âŒ';
                log(`${index + 1}. ${status} ${letter}: ${data.quality}%`, 'info');
            });
            
            const avgQuality = sortedGestures.reduce((sum, [,data]) => sum + data.quality, 0) / sortedGestures.length;
            log(`ğŸ“Š Qualidade mÃ©dia: ${avgQuality.toFixed(1)}%`, 'info');
            
            if (gestures.A) {
                const aQuality = gestures.A.quality;
                if (aQuality < 70) {
                    log(`âš ï¸ Letra A tem qualidade baixa (${aQuality}%)`, 'warning');
                    log(`ğŸ’¡ Tente recapturar com melhor iluminaÃ§Ã£o/posiÃ§Ã£o`, 'warning');
                }
            }
        }
        
        async function testRecognitionFlow() {
            clearOutput();
            log('ğŸ”„ TESTE DO FLUXO COMPLETO DE RECONHECIMENTO', 'info');
            log('='.repeat(45));
            
            // Simular exatamente o que acontece no jogo
            log('1ï¸âƒ£ Inicializando reconhecedor (como no jogo)...', 'info');
            
            const gameRecognizer = new CustomGestureRecognizer();
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            log('2ï¸âƒ£ Obtendo gestos salvos...', 'info');
            const response = await fetch('/api/get_gestures');
            const gestures = await response.json();
            
            if (!gestures.A) {
                log('âŒ Letra A nÃ£o disponÃ­vel!', 'error');
                return;
            }
            
            log('3ï¸âƒ£ Simulando captura de landmarks no jogo...', 'info');
            const testLandmarks = gestures.A.landmarks.map(point => ({
                x: point.x + (Math.random() - 0.5) * 0.02, // Pequena variaÃ§Ã£o
                y: point.y + (Math.random() - 0.5) * 0.02,
                z: point.z + (Math.random() - 0.5) * 0.01
            }));
            
            log('4ï¸âƒ£ Tentando reconhecimento...', 'info');
            
            for (let attempt = 1; attempt <= 5; attempt++) {
                const result = await gameRecognizer.recognizeLetter(testLandmarks);
                
                if (result) {
                    log(`   Tentativa ${attempt}: ${result.letter} (${(result.confidence * 100).toFixed(1)}%) - EstÃ¡vel: ${result.stable}`, 
                        result.letter === 'A' ? 'success' : 'warning');
                    
                    if (result.stable && result.letter === 'A') {
                        log('âœ… SUCESSO! Reconhecimento estÃ¡vel da letra A', 'success');
                        break;
                    }
                } else {
                    log(`   Tentativa ${attempt}: Nenhuma letra reconhecida`, 'warning');
                }
                
                // Pequena pausa entre tentativas
                await new Promise(resolve => setTimeout(resolve, 100));
            }
        }
        
        async function checkGameIntegration() {
            clearOutput();
            log('ğŸ® VERIFICANDO INTEGRAÃ‡ÃƒO COM O JOGO', 'info');
            log('='.repeat(35));
            
            // Verificar se o script estÃ¡ carregado no jogo
            log('ğŸ” Verificando arquivos JavaScript...', 'info');
            
            try {
                // Tentar carregar o script do reconhecedor
                const scriptResponse = await fetch('/static/js/custom-gesture-recognizer.js');
                if (scriptResponse.ok) {
                    log('âœ… Script custom-gesture-recognizer.js carregado', 'success');
                } else {
                    log('âŒ Erro ao carregar script principal', 'error');
                }
                
                // Verificar se a classe existe
                if (typeof CustomGestureRecognizer !== 'undefined') {
                    log('âœ… Classe CustomGestureRecognizer disponÃ­vel', 'success');
                } else {
                    log('âŒ Classe CustomGestureRecognizer nÃ£o encontrada', 'error');
                }
                
                log('ğŸ’¡ Para resolver problemas no jogo:', 'info');
                log('   1. Recarregue a pÃ¡gina do jogo (F5)', 'info');
                log('   2. Verifique console do navegador (F12)', 'info');
                log('   3. Certifique-se que capturou a letra A em /admin', 'info');
                
            } catch (error) {
                log(`âŒ Erro na verificaÃ§Ã£o: ${error.message}`, 'error');
            }
        }
        
        async function simulateGameRecognition() {
            clearOutput();
            log('ğŸ¯ SIMULAÃ‡ÃƒO DO RECONHECIMENTO NO JOGO', 'info');
            log('='.repeat(40));
            
            log('ğŸ”§ ConfiguraÃ§Ãµes do sistema:', 'info');
            log('   - Threshold de confianÃ§a: 75%', 'info');
            log('   - Frames para estabilidade: 3', 'info');
            log('   - DistÃ¢ncia mÃ¡xima: 2.0', 'info');
            
            // Buscar letra A
            const response = await fetch('/api/get_gestures');
            const gestures = await response.json();
            
            if (!gestures.A) {
                log('âŒ Letra A nÃ£o capturada!', 'error');
                return;
            }
            
            log('ğŸ¯ Testando com diferentes nÃ­veis de precisÃ£o...', 'info');
            
            const testCases = [
                { name: 'Landmarks idÃªnticos', variation: 0 },
                { name: 'Pequena variaÃ§Ã£o (1%)', variation: 0.01 },
                { name: 'VariaÃ§Ã£o mÃ©dia (3%)', variation: 0.03 },
                { name: 'VariaÃ§Ã£o alta (5%)', variation: 0.05 },
                { name: 'VariaÃ§Ã£o muito alta (10%)', variation: 0.10 }
            ];
            
            const gameRecognizer = new CustomGestureRecognizer();
            await new Promise(resolve => setTimeout(resolve, 1500));
            
            for (const testCase of testCases) {
                log(`\nğŸ§ª Teste: ${testCase.name}`, 'info');
                
                const testLandmarks = gestures.A.landmarks.map(point => ({
                    x: point.x + (Math.random() - 0.5) * testCase.variation,
                    y: point.y + (Math.random() - 0.5) * testCase.variation,
                    z: point.z + (Math.random() - 0.5) * testCase.variation * 0.5
                }));
                
                const result = await gameRecognizer.recognizeLetter(testLandmarks);
                
                if (result && result.letter === 'A') {
                    log(`   âœ… Reconhecido: ${(result.confidence * 100).toFixed(1)}%`, 'success');
                } else if (result) {
                    log(`   âš ï¸ Reconheceu '${result.letter}' (${(result.confidence * 100).toFixed(1)}%)`, 'warning');
                } else {
                    log(`   âŒ NÃ£o reconhecido`, 'error');
                }
            }
        }
        
        async function checkThresholds() {
            clearOutput();
            log('âš–ï¸ ANÃLISE DOS THRESHOLDS DE CONFIANÃ‡A', 'info');
            log('='.repeat(40));
            
            log('ğŸ”§ Threshold atual: 75%', 'info');
            log('ğŸ’¡ Testando com diferentes thresholds...', 'info');
            
            const response = await fetch('/api/get_gestures');
            const gestures = await response.json();
            
            if (!gestures.A) {
                log('âŒ Letra A nÃ£o disponÃ­vel para teste', 'error');
                return;
            }
            
            // Simular reconhecimento com diferentes thresholds
            const testLandmarks = gestures.A.landmarks;
            
            const thresholds = [0.5, 0.6, 0.7, 0.75, 0.8, 0.85, 0.9];
            
            for (const threshold of thresholds) {
                try {
                    const recognizeResponse = await fetch('/api/recognize_gesture', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ landmarks: testLandmarks })
                    });
                    
                    const result = await recognizeResponse.json();
                    
                    if (result.success && result.result.confidence >= threshold) {
                        log(`âœ… Threshold ${(threshold*100).toFixed(0)}%: APROVADO (${(result.result.confidence*100).toFixed(1)}%)`, 'success');
                    } else {
                        log(`âŒ Threshold ${(threshold*100).toFixed(0)}%: REPROVADO`, 'error');
                    }
                    
                } catch (error) {
                    log(`âŒ Erro no teste: ${error.message}`, 'error');
                }
            }
            
            log('\nğŸ’¡ RecomendaÃ§Ãµes:', 'info');
            log('   - Se muitos reprovados: diminuir threshold', 'info');
            log('   - Se falsos positivos: aumentar threshold', 'info');
        }
        
        async function debugLandmarks() {
            clearOutput();
            log('ğŸ“ DEBUG DETALHADO DOS LANDMARKS', 'info');
            log('='.repeat(35));
            
            const response = await fetch('/api/get_gestures');
            const gestures = await response.json();
            
            if (!gestures.A) {
                log('âŒ Letra A nÃ£o disponÃ­vel', 'error');
                return;
            }
            
            const landmarks = gestures.A.landmarks;
            
            log('ğŸ“Š AnÃ¡lise dos 21 landmarks da letra A:', 'info');
            log('='.repeat(35));
            
            landmarks.forEach((point, index) => {
                const fingerNames = [
                    'Pulso', 'Polegar_CMC', 'Polegar_MCP', 'Polegar_IP', 'Polegar_Ponta',
                    'Indicador_MCP', 'Indicador_PIP', 'Indicador_DIP', 'Indicador_Ponta',
                    'MÃ©dio_MCP', 'MÃ©dio_PIP', 'MÃ©dio_DIP', 'MÃ©dio_Ponta',
                    'Anelar_MCP', 'Anelar_PIP', 'Anelar_DIP', 'Anelar_Ponta',
                    'Mindinho_MCP', 'Mindinho_PIP', 'Mindinho_DIP', 'Mindinho_Ponta'
                ];
                
                const name = fingerNames[index] || `Ponto_${index}`;
                const valid = point.x >= 0 && point.x <= 1 && point.y >= 0 && point.y <= 1;
                const status = valid ? 'âœ…' : 'âŒ';
                
                log(`${index.toString().padStart(2)}: ${status} ${name.padEnd(15)} X:${point.x.toFixed(3)} Y:${point.y.toFixed(3)} Z:${point.z.toFixed(3)}`, 'info');
            });
            
            // Verificar se a mÃ£o estÃ¡ "fechada" (caracterÃ­stica da letra A)
            const fingertips = [4, 8, 12, 16, 20]; // Pontas dos dedos
            const palm = landmarks[0]; // Pulso
            
            let avgDistanceToPalm = 0;
            fingertips.forEach(tipIndex => {
                const tip = landmarks[tipIndex];
                const distance = Math.sqrt(
                    Math.pow(tip.x - palm.x, 2) + 
                    Math.pow(tip.y - palm.y, 2)
                );
                avgDistanceToPalm += distance;
            });
            avgDistanceToPalm /= fingertips.length;
            
            log(`\nğŸ¤ AnÃ¡lise da "fechadura" da mÃ£o:`, 'info');
            log(`   DistÃ¢ncia mÃ©dia das pontas ao pulso: ${avgDistanceToPalm.toFixed(3)}`, 'info');
            
            if (avgDistanceToPalm < 0.15) {
                log(`   âœ… MÃ£o parece fechada (boa para letra A)`, 'success');
            } else {
                log(`   âš ï¸ MÃ£o parece aberta (pode nÃ£o ser letra A ideal)`, 'warning');
            }
        }
    </script>
</body>
</html>