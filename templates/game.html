{% extends "base.html" %}

{% block title %}Jogo - Libras Learning{% endblock %}

{% block head %}
<style>
.camera-container {
    position: relative;
    background: #000;
    border-radius: 10px;
    overflow: hidden;
}

#videoElement {
    width: 100%;
    height: auto;
    display: block;
}

.camera-overlay {
    position: absolute;
    top: 10px;
    left: 10px;
    background: rgba(0, 0, 0, 0.7);
    color: white;
    padding: 10px;
    border-radius: 5px;
    font-size: 14px;
}

.game-stats {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 10px;
    padding: 20px;
}

.letter-display {
    font-size: 4rem;
    font-weight: bold;
    text-align: center;
    background: #f8f9fa;
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 20px;
}

.progress-ring {
    width: 120px;
    height: 120px;
    margin: 0 auto;
}

.recognition-feedback {
    min-height: 80px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.word-progress {
    margin-bottom: 20px;
}

.current-word {
    font-size: 2.5rem;
    font-weight: bold;
    color: #495057;
}

.letter-boxes {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin-top: 15px;
}

.letter-box {
    width: 50px;
    height: 50px;
    border: 3px solid #dee2e6;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    font-weight: bold;
    background: white;
    transition: all 0.3s ease;
}

.letter-box.current {
    border-color: #007bff;
    background: #e3f2fd;
}

.letter-box.completed {
    border-color: #28a745;
    background: #d4edda;
    color: #155724;
}

.letter-box.incorrect {
    border-color: #dc3545;
    background: #f8d7da;
    color: #721c24;
    animation: shake 0.5s ease-in-out;
}

@keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-5px); }
    75% { transform: translateX(5px); }
}
</style>
{% endblock %}

{% block content %}
<!-- Alerta sobre vers√£o de demonstra√ß√£o -->
<div class="alert alert-info alert-dismissible fade show" role="alert">
    <i class="fas fa-info-circle"></i>
    <strong>Vers√£o de Demonstra√ß√£o:</strong> O reconhecimento por c√¢mera n√£o est√° dispon√≠vel nesta vers√£o online. 
    Use os bot√µes "Ver Demonstra√ß√£o" para visualizar os sinais e "Simular Resposta" para testar o jogo.
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>

<div class="row">
    <!-- Game Controls -->
    <div class="col-12 mb-4">
        <div class="card">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h4 class="mb-0">Configura√ß√£o do Jogo</h4>
                        <small class="text-muted">Escolha o modo e dificuldade</small>
                    </div>
                    <div class="col-md-4 text-md-end">
                        <button class="btn btn-primary" id="startGameBtn">
                            <i class="fas fa-play"></i> Iniciar
                        </button>
                        <button class="btn btn-danger d-none" id="stopGameBtn">
                            <i class="fas fa-stop"></i> Parar
                        </button>
                    </div>
                </div>
                
                <hr class="my-3">
                
                <!-- Game Mode Selection -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label">Modo de Jogo:</label>
                        <select class="form-select" id="gameModeSelect">
                            <option value="normal">üéØ Reconhecimento Normal</option>
                            <option value="soletracao">‚úèÔ∏è Soletra√ß√£o Customizada</option>
                            <option value="desafio">‚ö° Desafio com Tempo</option>
                        </select>
                        <div class="form-text" id="modeDescription">
                            Reconhecimento livre em tempo real
                        </div>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Dificuldade:</label>
                        <select class="form-select" id="difficultySelect">
                            <option value="iniciante">üå± Iniciante</option>
                            <option value="intermediario">üåø Intermedi√°rio</option>
                            <option value="avancado">üå≥ Avan√ßado</option>
                            <option value="expert">üèÜ Expert</option>
                        </select>
                    </div>
                </div>
                
                <!-- Custom Word Input (for Soletra√ß√£o mode) -->
                <div class="row d-none" id="customWordContainer">
                    <div class="col-md-8">
                        <label class="form-label">Palavra para Soletrar:</label>
                        <input type="text" class="form-control" id="customWordInput" 
                               placeholder="Digite a palavra que deseja soletrar" maxlength="20">
                        <div class="form-text">Digite apenas letras (m√°ximo 20 caracteres)</div>
                    </div>
                    <div class="col-md-4 d-flex align-items-end">
                        <button class="btn btn-outline-primary" id="validateWordBtn">
                            <i class="fas fa-check"></i> Validar Palavra
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Game Interface -->
    <div class="col-lg-8">
        <!-- Camera Feed -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-camera"></i> C√¢mera
                    <span id="cameraStatus" class="badge bg-secondary ms-2">Desconectada</span>
                </h5>
            </div>
            <div class="card-body p-0">
                <div class="camera-container">
                    <video id="videoElement" autoplay muted playsinline></video>
                    <canvas id="canvasElement" style="display: none;"></canvas>
                    <div class="camera-overlay">
                        <div>FPS: <span id="fpsCounter">0</span></div>
                        <div>Confian√ßa: <span id="confidenceDisplay">0%</span></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recognition Feedback -->
        <div class="card">
            <div class="card-body recognition-feedback">
                <div id="recognitionResult" class="text-center">
                    <h3 class="text-muted">Inicie o jogo para come√ßar</h3>
                </div>
            </div>
        </div>

        <!-- Video Demonstration -->
        <div class="card mt-4 d-none" id="videoDemonstrationCard">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="mb-0">
                    <i class="fas fa-play-circle"></i> Demonstra√ß√£o da Letra <span id="demoLetterTitle">-</span>
                </h6>
                <button class="btn btn-sm btn-outline-secondary" id="closeDemoBtn">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="card-body p-0">
                <div class="video-demo-container">
                    <video id="demoVideoElement" controls muted style="width: 100%; height: auto; max-height: 300px;">
                        Seu navegador n√£o suporta v√≠deos.
                    </video>
                </div>
                <div class="p-3 text-center">
                    <p class="text-muted small mb-2">
                        Assista √† demonstra√ß√£o e depois pratique o sinal
                    </p>
                    <button class="btn btn-primary btn-sm" id="startPracticeBtn">
                        <i class="fas fa-hand-paper"></i> Come√ßar Pr√°tica
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Game Stats and Progress -->
    <div class="col-lg-4">
        <!-- Current Word/Challenge -->
        <div class="card mb-4" id="gameContent" style="display: none;">
            <div class="card-body text-center">
                <div id="normalModeContent" class="d-none">
                    <h6 class="card-subtitle mb-2 text-muted">Modo Reconhecimento Normal</h6>
                    <div class="alert alert-info">
                        <i class="fas fa-hand-paper"></i>
                        Fa√ßa sinais com as m√£os e veja o reconhecimento em tempo real
                    </div>
                    <div class="mt-4">
                        <h3 class="text-muted">Letra Detectada:</h3>
                        <div class="display-1 text-primary font-weight-bold" id="detectedLetter">-</div>
                        <small class="text-muted">Fa√ßa um sinal para come√ßar o reconhecimento</small>
                    </div>
                    <div class="mt-3">
                        <button class="btn btn-info btn-sm" onclick="window.showVideoDemo('A')">
                            <i class="fas fa-play-circle"></i> Ver Demonstra√ß√£o
                        </button>
                    </div>
                </div>
                
                <div id="soletracaoModeContent" class="d-none">
                    <h6 class="card-subtitle mb-2 text-muted">Palavra para Soletrar</h6>
                    <div class="current-word" id="currentWord">---</div>
                    <div class="letter-boxes" id="letterBoxes">
                        <!-- Letter boxes will be generated here -->
                    </div>
                    <div class="mt-3">
                        <small class="text-muted">
                            Letra: <span id="letterPosition">0</span> / <span id="totalLetters">0</span>
                        </small>
                    </div>
                    <div class="mt-3">
                        <button class="btn btn-info btn-sm" id="showDemoBtn" onclick="showCurrentLetterDemo()">
                            <i class="fas fa-play-circle"></i> Ver Demonstra√ß√£o
                        </button>
                    </div>
                </div>
                
                <div id="desafioModeContent" class="d-none">
                    <h6 class="card-subtitle mb-2 text-muted">Modo Desafio</h6>
                    <div class="current-word" id="challengeWord">---</div>
                    <div class="letter-boxes" id="challengeLetterBoxes">
                        <!-- Letter boxes will be generated here -->
                    </div>
                    <div class="mt-3">
                        <div class="row text-center">
                            <div class="col-6">
                                <small class="text-muted">
                                    Palavra: <span id="challengeWordCount">0</span> / <span id="totalChallengeWords">10</span>
                                </small>
                            </div>
                            <div class="col-6">
                                <small class="text-muted">
                                    Letra: <span id="challengeLetterPosition">0</span> / <span id="challengeTotalLetters">0</span>
                                </small>
                            </div>
                        </div>
                    </div>
                    <div class="mt-3 text-center">
                        <button class="btn btn-info btn-sm" id="showChallengeDemoBtn" onclick="showCurrentLetterDemo()">
                            <i class="fas fa-play-circle"></i> Ver Demonstra√ß√£o
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Game Statistics -->
        <div class="card mb-4">
            <div class="card-body game-stats">
                <h6 class="mb-3">Estat√≠sticas da Sess√£o</h6>
                <div class="row text-center">
                    <div class="col-6 mb-3">
                        <div class="h4 mb-0" id="wordsCompleted">0</div>
                        <small>Palavras</small>
                    </div>
                    <div class="col-6 mb-3">
                        <div class="h4 mb-0" id="accuracy">0%</div>
                        <small>Precis√£o</small>
                    </div>
                    <div class="col-6">
                        <div class="h4 mb-0" id="totalTime">00:00</div>
                        <small>Tempo Total</small>
                    </div>
                    <div class="col-6">
                        <div class="h4 mb-0" id="currentStreak">0</div>
                        <small>Sequ√™ncia</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Timer (only for Desafio mode) -->
        <div class="card" id="timerCard" style="display: none;">
            <div class="card-body text-center">
                <h6 class="card-subtitle mb-2 text-muted">Tempo Restante</h6>
                <div class="progress-ring">
                    <svg width="120" height="120">
                        <circle cx="60" cy="60" r="50" stroke="#e9ecef" stroke-width="8" fill="none"/>
                        <circle id="progressCircle" cx="60" cy="60" r="50" stroke="#007bff" 
                                stroke-width="8" fill="none" stroke-linecap="round"
                                style="transform: rotate(-90deg); transform-origin: 60px 60px; 
                                       stroke-dasharray: 314; stroke-dashoffset: 314;"/>
                    </svg>
                    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);">
                        <div class="h3 mb-0" id="timeRemaining">180</div>
                        <small class="text-muted">segundos</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/camera.js') }}"></script>
<script src="{{ url_for('static', filename='js/game.js') }}"></script>
<script>
// Fun√ß√£o global para mostrar demonstra√ß√£o
window.showVideoDemo = async function(letter) {
    console.log('showVideoDemo called with letter:', letter);
    try {
        const response = await fetch(`/api/get_video_demo/${letter}`);
        const data = await response.json();
        
        if (data.success) {
            const demoCard = document.getElementById('videoDemonstrationCard');
            const demoVideo = document.getElementById('demoVideoElement');
            const demoTitle = document.getElementById('demoLetterTitle');
            
            if (demoCard && demoVideo && demoTitle) {
                demoTitle.textContent = letter;
                demoVideo.src = data.video_url;
                demoCard.classList.remove('d-none');
                showAlert(`Demonstra√ß√£o da letra ${letter}`, 'info');
            }
        } else {
            showAlert(`V√≠deo n√£o dispon√≠vel para a letra ${letter}`, 'warning');
        }
    } catch (error) {
        console.error('Error showing demo:', error);
        showAlert('Erro ao carregar v√≠deo: ' + error.message, 'danger');
    }
};

// Fun√ß√£o para esconder demonstra√ß√£o
window.hideVideoDemo = function() {
    const demoCard = document.getElementById('videoDemonstrationCard');
    const demoVideo = document.getElementById('demoVideoElement');
    
    if (demoCard && demoVideo) {
        demoCard.classList.add('d-none');
        demoVideo.pause();
        demoVideo.src = '';
    }
};

// Game state
let gameState = {
    isActive: false,
    currentWord: '',
    currentLetterIndex: 0,
    mode: 'iniciante'
};

// Initialize when page loads
document.addEventListener('DOMContentLoaded', function() {
    console.log('Game page loaded');
    
    // Setup camera manager
    if (typeof CameraManager !== 'undefined') {
        window.cameraManager = new CameraManager();
        window.cameraManager.init();
    }
    
    // Setup game instance
    if (typeof LibrasGame !== 'undefined') {
        window.gameInstance = new LibrasGame();
    }
    
    // Setup demo buttons
    setupDemoButtons();
});

function setupDemoButtons() {
    // Setup demo button events
    const demoButtons = document.querySelectorAll('[id*="DemoBtn"]');
    demoButtons.forEach(btn => {
        btn.addEventListener('click', function() {
            const letter = getCurrentLetter() || 'A';
            window.showVideoDemo(letter);
        });
    });
    
    // Close demo button
    const closeDemoBtn = document.getElementById('closeDemoBtn');
    if (closeDemoBtn) {
        closeDemoBtn.addEventListener('click', window.hideVideoDemo);
    }
}

function getCurrentLetter() {
    console.log('getCurrentLetter called');
    console.log('window.gameInstance exists:', !!window.gameInstance);
    
    // Acessar a inst√¢ncia global do jogo
    if (window.gameInstance && window.gameInstance.gameState) {
        const gameState = window.gameInstance.gameState;
        console.log('gameState:', gameState);
        console.log('currentWord:', gameState.currentWord);
        console.log('currentLetterIndex:', gameState.currentLetterIndex);
        
        if (gameState.currentWord && gameState.currentLetterIndex < gameState.currentWord.length) {
            const letter = gameState.currentWord[gameState.currentLetterIndex];
            console.log('Returning letter:', letter);
            return letter;
        }
    }
    console.log('Returning default letter A');
    return 'A'; // Default letter for demo
}

function showCurrentLetterDemo() {
    console.log('showCurrentLetterDemo called');
    
    const currentLetter = getCurrentLetter();
    console.log('Current letter for demo:', currentLetter);
    
    if (window.showVideoDemo) {
        console.log('Showing video demo for letter:', currentLetter);
        window.showVideoDemo(currentLetter);
    } else {
        console.error('showVideoDemo function not available');
        alert(`Demonstra√ß√£o da letra: ${currentLetter}`);
    }
}

console.log('Game scripts loaded successfully');
</script>
{% endblock %}