{% extends "base.html" %}

{% block title %}Jogo - Libras Learning{% endblock %}

{% block head %}
<style>
.camera-container {
    position: relative;
    background: #000;
    border-radius: 10px;
    overflow: hidden;
}

#videoElement {
    width: 100%;
    height: auto;
    display: block;
}

.camera-overlay {
    position: absolute;
    top: 10px;
    left: 10px;
    background: rgba(0, 0, 0, 0.7);
    color: white;
    padding: 10px;
    border-radius: 5px;
    font-size: 14px;
}

.game-stats {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 10px;
    padding: 20px;
}

.letter-display {
    font-size: 4rem;
    font-weight: bold;
    text-align: center;
    background: #f8f9fa;
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 20px;
}

.progress-ring {
    width: 120px;
    height: 120px;
    margin: 0 auto;
}

.recognition-feedback {
    min-height: 80px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.word-progress {
    margin-bottom: 20px;
}

.current-word {
    font-size: 2.5rem;
    font-weight: bold;
    color: #495057;
}

.letter-boxes {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin-top: 15px;
}

.letter-box {
    width: 50px;
    height: 50px;
    border: 3px solid #dee2e6;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    font-weight: bold;
    background: white;
    transition: all 0.3s ease;
}

.letter-box.current {
    border-color: #007bff;
    background: #e3f2fd;
}

.letter-box.completed {
    border-color: #28a745;
    background: #d4edda;
    color: #155724;
}

.letter-box.incorrect {
    border-color: #dc3545;
    background: #f8d7da;
    color: #721c24;
    animation: shake 0.5s ease-in-out;
}

@keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-5px); }
    75% { transform: translateX(5px); }
}
</style>
{% endblock %}

{% block content %}
<div class="row">
    <!-- Game Controls -->
    <div class="col-12 mb-4">
        <div class="card">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h4 class="mb-0">Configura√ß√£o do Jogo</h4>
                        <small class="text-muted">Escolha o modo e dificuldade</small>
                    </div>
                    <div class="col-md-4 text-md-end">
                        <button class="btn btn-primary" id="startGameBtn">
                            <i class="fas fa-play"></i> Iniciar
                        </button>
                        <button class="btn btn-danger d-none" id="stopGameBtn">
                            <i class="fas fa-stop"></i> Parar
                        </button>
                    </div>
                </div>
                
                <hr class="my-3">
                
                <!-- Game Mode Selection -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label">Modo de Jogo:</label>
                        <select class="form-select" id="gameModeSelect">
                            <option value="normal">üéØ Reconhecimento Normal</option>
                            <option value="soletracao">‚úèÔ∏è Soletra√ß√£o Customizada</option>
                            <option value="desafio">‚ö° Desafio com Tempo</option>
                        </select>
                        <div class="form-text" id="modeDescription">
                            Reconhecimento livre em tempo real
                        </div>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Dificuldade:</label>
                        <select class="form-select" id="difficultySelect">
                            <option value="iniciante">üå± Iniciante</option>
                            <option value="intermediario">üåø Intermedi√°rio</option>
                            <option value="avancado">üå≥ Avan√ßado</option>
                            <option value="expert">üèÜ Expert</option>
                        </select>
                    </div>
                </div>
                
                <!-- Custom Word Input (for Soletra√ß√£o mode) -->
                <div class="row d-none" id="customWordContainer">
                    <div class="col-md-8">
                        <label class="form-label">Palavra para Soletrar:</label>
                        <input type="text" class="form-control" id="customWordInput" 
                               placeholder="Digite a palavra que deseja soletrar" maxlength="20">
                        <div class="form-text">Digite apenas letras (m√°ximo 20 caracteres)</div>
                    </div>
                    <div class="col-md-4 d-flex align-items-end">
                        <button class="btn btn-outline-primary" id="validateWordBtn">
                            <i class="fas fa-check"></i> Validar Palavra
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Game Interface -->
    <div class="col-lg-8">
        <!-- Camera Feed -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-camera"></i> C√¢mera
                    <span id="cameraStatus" class="badge bg-secondary ms-2">Desconectada</span>
                </h5>
            </div>
            <div class="card-body p-0">
                <div class="camera-container">
                    <video id="videoElement" autoplay muted playsinline></video>
                    <canvas id="canvasElement" style="display: none;"></canvas>
                    <div class="camera-overlay">
                        <div>FPS: <span id="fpsCounter">0</span></div>
                        <div>Confian√ßa: <span id="confidenceDisplay">0%</span></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recognition Feedback -->
        <div class="card">
            <div class="card-body recognition-feedback">
                <div id="recognitionResult" class="text-center">
                    <h3 class="text-muted">Inicie o jogo para come√ßar</h3>
                </div>
            </div>
        </div>

        <!-- Video Demonstration -->
        <div class="card mt-4 d-none" id="videoDemonstrationCard">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="mb-0">
                    <i class="fas fa-play-circle"></i> Demonstra√ß√£o da Letra <span id="demoLetterTitle">-</span>
                </h6>
                <button class="btn btn-sm btn-outline-secondary" id="closeDemoBtn">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="card-body p-0">
                <div class="video-demo-container">
                    <video id="demoVideoElement" controls muted style="width: 100%; height: auto; max-height: 300px;">
                        Seu navegador n√£o suporta v√≠deos.
                    </video>
                </div>
                <div class="p-3 text-center">
                    <p class="text-muted small mb-2">
                        Assista √† demonstra√ß√£o e depois pratique o sinal
                    </p>
                    <button class="btn btn-primary btn-sm" id="startPracticeBtn">
                        <i class="fas fa-hand-paper"></i> Come√ßar Pr√°tica
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Game Stats and Progress -->
    <div class="col-lg-4">
        <!-- Current Word/Challenge -->
        <div class="card mb-4" id="gameContent" style="display: none;">
            <div class="card-body text-center">
                <div id="normalModeContent" class="d-none">
                    <h6 class="card-subtitle mb-2 text-muted">Modo Reconhecimento Normal</h6>
                    <div class="alert alert-info">
                        <i class="fas fa-hand-paper"></i>
                        Fa√ßa sinais com as m√£os e veja o reconhecimento em tempo real
                    </div>
                </div>
                
                <div id="soletracaoModeContent" class="d-none">
                    <h6 class="card-subtitle mb-2 text-muted">Palavra para Soletrar</h6>
                    <div class="current-word" id="currentWord">---</div>
                    <div class="letter-boxes" id="letterBoxes">
                        <!-- Letter boxes will be generated here -->
                    </div>
                    <div class="mt-3">
                        <small class="text-muted">
                            Letra: <span id="letterPosition">0</span> / <span id="totalLetters">0</span>
                        </small>
                    </div>
                    <div class="mt-3">
                        <button class="btn btn-info btn-sm" id="showDemoBtn" onclick="(() => { const letter = getCurrentLetter(); window.showVideoDemo(letter || 'A'); })()">
                            <i class="fas fa-play-circle"></i> Ver Demonstra√ß√£o
                        </button>
                    </div>
                </div>
                
                <div id="desafioModeContent" class="d-none">
                    <h6 class="card-subtitle mb-2 text-muted">Modo Desafio</h6>
                    <div class="current-word" id="challengeWord">---</div>
                    <div class="letter-boxes" id="challengeLetterBoxes">
                        <!-- Letter boxes will be generated here -->
                    </div>
                    <div class="mt-3">
                        <div class="row text-center">
                            <div class="col-6">
                                <small class="text-muted">
                                    Palavra: <span id="challengeWordCount">0</span> / <span id="totalChallengeWords">10</span>
                                </small>
                            </div>
                            <div class="col-6">
                                <small class="text-muted">
                                    Letra: <span id="challengeLetterPosition">0</span> / <span id="challengeTotalLetters">0</span>
                                </small>
                            </div>
                        </div>
                    </div>
                    <div class="mt-3 text-center">
                        <button class="btn btn-info btn-sm" id="showChallengeDemoBtn" onclick="(() => { const letter = getCurrentLetter(); window.showVideoDemo(letter || 'A'); })()">
                            <i class="fas fa-play-circle"></i> Ver Demonstra√ß√£o
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Game Statistics -->
        <div class="card mb-4">
            <div class="card-body game-stats">
                <h6 class="mb-3">Estat√≠sticas da Sess√£o</h6>
                <div class="row text-center">
                    <div class="col-6 mb-3">
                        <div class="h4 mb-0" id="wordsCompleted">0</div>
                        <small>Palavras</small>
                    </div>
                    <div class="col-6 mb-3">
                        <div class="h4 mb-0" id="accuracy">0%</div>
                        <small>Precis√£o</small>
                    </div>
                    <div class="col-6">
                        <div class="h4 mb-0" id="totalTime">00:00</div>
                        <small>Tempo Total</small>
                    </div>
                    <div class="col-6">
                        <div class="h4 mb-0" id="currentStreak">0</div>
                        <small>Sequ√™ncia</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Timer (only for Desafio mode) -->
        <div class="card" id="timerCard" style="display: none;">
            <div class="card-body text-center">
                <h6 class="card-subtitle mb-2 text-muted">Tempo Restante</h6>
                <div class="progress-ring">
                    <svg width="120" height="120">
                        <circle cx="60" cy="60" r="50" stroke="#e9ecef" stroke-width="8" fill="none"/>
                        <circle id="progressCircle" cx="60" cy="60" r="50" stroke="#007bff" 
                                stroke-width="8" fill="none" stroke-linecap="round"
                                style="transform: rotate(-90deg); transform-origin: 60px 60px; 
                                       stroke-dasharray: 314; stroke-dashoffset: 314;"/>
                    </svg>
                    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);">
                        <div class="h3 mb-0" id="timeRemaining">180</div>
                        <small class="text-muted">segundos</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/camera.js') }}"></script>
<script src="{{ url_for('static', filename='js/game.js') }}"></script>
<script>
console.log('Game page initialization starting...');

// Fun√ß√£o global para mostrar demonstra√ß√£o
window.showVideoDemo = async function(letter) {
    console.log('showVideoDemo called with letter:', letter);
    try {
        // Get video information
        const response = await fetch(`/api/get_video_demo/${letter}`);
        const data = await response.json();
        
        console.log('Video API response:', data);
        
        if (data.success && data.video_available) {
            // Find elements
            const demoCard = document.getElementById('videoDemonstrationCard');
            const demoVideo = document.getElementById('demoVideoElement');
            const demoTitle = document.getElementById('demoLetterTitle');
            
            if (demoCard && demoVideo && demoTitle) {
                // Update UI
                demoTitle.textContent = letter;
                demoVideo.src = data.video_url;
                demoCard.classList.remove('d-none');
                
                console.log('Demo shown successfully for letter:', letter);
            } else {
                console.error('Demo elements not found');
            }
        } else {
            alert(`V√≠deo n√£o dispon√≠vel para a letra ${letter}`);
        }
    } catch (error) {
        console.error('Error showing demo:', error);
        alert('Erro ao carregar v√≠deo: ' + error.message);
    }
};

// Fun√ß√£o para esconder demonstra√ß√£o
window.hideVideoDemo = function() {
    const demoCard = document.getElementById('videoDemonstrationCard');
    const demoVideo = document.getElementById('demoVideoElement');
    
    if (demoCard && demoVideo) {
        demoCard.classList.add('d-none');
        demoVideo.pause();
        demoVideo.src = '';
        console.log('Demo hidden');
    }
};

// Game state management
let gameState = {
    isActive: false,
    mode: 'normal', // normal, soletracao, desafio
    currentWord: '',
    currentLetterIndex: 0,
    words: [],
    currentWordIndex: 0,
    customWord: '',
    sessionStats: {
        wordsCompleted: 0,
        totalLetters: 0,
        correctLetters: 0,
        startTime: null,
        sessionId: null
    },
    difficulty: 'iniciante',
    timeRemaining: 180,
    timerInterval: null,
    challengeWordsTotal: 10
};

// Initialize when page loads
document.addEventListener('DOMContentLoaded', function() {
    initializeGame();
});

function initializeGame() {
    // Setup camera
    if (typeof CameraManager !== 'undefined') {
        CameraManager.init();
    }
    
    // Setup event listeners
    document.getElementById('startGameBtn').addEventListener('click', startGame);
    document.getElementById('stopGameBtn').addEventListener('click', stopGame);
    document.getElementById('gameModeSelect').addEventListener('change', onModeChange);
    document.getElementById('difficultySelect').addEventListener('change', function() {
        gameState.difficulty = this.value;
    });
    document.getElementById('validateWordBtn').addEventListener('click', validateCustomWord);
    
    // Demo button event listeners
    const showDemoBtn = document.getElementById('showDemoBtn');
    if (showDemoBtn) {
        showDemoBtn.addEventListener('click', function() {
            console.log('Show demo button clicked');
            const currentLetter = getCurrentLetter();
            if (currentLetter) {
                window.showVideoDemo(currentLetter);
            } else {
                window.showVideoDemo('A'); // Default for testing
            }
        });
    }
    
    const showChallengeDemoBtn = document.getElementById('showChallengeDemoBtn');
    if (showChallengeDemoBtn) {
        showChallengeDemoBtn.addEventListener('click', function() {
            console.log('Show challenge demo button clicked');
            const currentLetter = getCurrentLetter();
            if (currentLetter) {
                window.showVideoDemo(currentLetter);
            } else {
                window.showVideoDemo('B'); // Default for testing
            }
        });
    }
    
    // Close demo button
    const closeDemoBtn = document.getElementById('closeDemoBtn');
    if (closeDemoBtn) {
        closeDemoBtn.addEventListener('click', window.hideVideoDemo);
    }
    
    // Start practice button
    const startPracticeBtn = document.getElementById('startPracticeBtn');
    if (startPracticeBtn) {
        startPracticeBtn.addEventListener('click', window.hideVideoDemo);
    }
    
    // Setup initial mode
    onModeChange();
}

function getCurrentLetter() {
    if (gameState.currentWord && gameState.currentLetterIndex < gameState.currentWord.length) {
        return gameState.currentWord[gameState.currentLetterIndex];
    }
    return null;
}

function onModeChange() {
    const mode = document.getElementById('gameModeSelect').value;
    const customWordContainer = document.getElementById('customWordContainer');
    const modeDescription = document.getElementById('modeDescription');
    
    gameState.mode = mode;
    
    // Show/hide custom word input
    if (mode === 'soletracao') {
        customWordContainer.classList.remove('d-none');
        modeDescription.textContent = 'Digite uma palavra para soletrar letra por letra';
    } else {
        customWordContainer.classList.add('d-none');
        if (mode === 'normal') {
            modeDescription.textContent = 'Reconhecimento livre em tempo real';
        } else if (mode === 'desafio') {
            modeDescription.textContent = 'Palavras aleat√≥rias com tempo limitado';
        }
    }
}

async function validateCustomWord() {
    const wordInput = document.getElementById('customWordInput');
    const word = wordInput.value.trim();
    
    if (!word) {
        showAlert('Digite uma palavra primeiro', 'warning');
        return;
    }
    
    if (!word.match(/^[a-zA-Z]+$/)) {
        showAlert('A palavra deve conter apenas letras', 'warning');
        return;
    }
    
    try {
        const response = await fetch('/api/validate_word', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                word: word,
                difficulty: gameState.difficulty
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            gameState.customWord = data.filtered_word;
            
            if (data.warning) {
                showAlert(data.warning, 'warning');
            } else {
                showAlert(`Palavra "${data.filtered_word}" validada!`, 'success');
            }
            
            wordInput.value = data.filtered_word;
        } else {
            showAlert(data.message, 'danger');
        }
    } catch (error) {
        console.error('Erro ao validar palavra:', error);
        showAlert('Erro ao validar palavra', 'danger');
    }
}

async function startGame() {
    try {
        // Valida√ß√µes espec√≠ficas por modo
        if (gameState.mode === 'soletracao') {
            const word = document.getElementById('customWordInput').value.trim();
            if (!word) {
                showAlert('Digite uma palavra para soletrar', 'warning');
                return;
            }
            if (!gameState.customWord) {
                showAlert('Valide a palavra antes de iniciar', 'warning');
                return;
            }
        }
        
        // Preparar dados da sess√£o
        const sessionData = {
            mode: gameState.mode,
            difficulty: gameState.difficulty
        };
        
        if (gameState.mode === 'soletracao') {
            sessionData.custom_word = gameState.customWord;
        }
        
        // Carregar palavras para modo desafio
        if (gameState.mode === 'desafio') {
            const response = await fetch(`/api/words/${gameState.difficulty}`);
            const data = await response.json();
            
            if (!data.success) {
                showAlert('Erro ao carregar palavras', 'danger');
                return;
            }
            
            gameState.words = data.words;
            gameState.currentWordIndex = 0;
        }
        
        // Iniciar sess√£o
        gameState.isActive = true;
        gameState.sessionStats.startTime = Date.now();
        
        await startGameSession(sessionData);
        
        // Start camera
        if (typeof CameraManager !== 'undefined') {
            await CameraManager.start();
        }
        
        // Setup UI baseado no modo
        setupGameUI();
        
        // Inicializar conte√∫do espec√≠fico do modo
        if (gameState.mode === 'normal') {
            setupNormalMode();
        } else if (gameState.mode === 'soletracao') {
            setupSoletracaoMode();
        } else if (gameState.mode === 'desafio') {
            setupDesafioMode();
        }
        
        const modeNames = {
            'normal': 'Reconhecimento Normal',
            'soletracao': 'Soletra√ß√£o',
            'desafio': 'Desafio'
        };
        
        showAlert(`Modo ${modeNames[gameState.mode]} iniciado!`, 'success');
        
    } catch (error) {
        console.error('Erro ao iniciar jogo:', error);
        showAlert('Erro ao iniciar o jogo', 'danger');
    }
}

function setupGameUI() {
    // Toggle buttons
    document.getElementById('startGameBtn').classList.add('d-none');
    document.getElementById('stopGameBtn').classList.remove('d-none');
    document.getElementById('gameContent').style.display = 'block';
    
    // Hide all mode contents initially
    document.getElementById('normalModeContent').classList.add('d-none');
    document.getElementById('soletracaoModeContent').classList.add('d-none'); 
    document.getElementById('desafioModeContent').classList.add('d-none');
    
    // Show timer only for desafio mode
    if (gameState.mode === 'desafio') {
        document.getElementById('timerCard').style.display = 'block';
        startTimer();
    }
}

function setupNormalMode() {
    document.getElementById('normalModeContent').classList.remove('d-none');
    // Normal mode is just free recognition
}

function setupSoletracaoMode() {
    document.getElementById('soletracaoModeContent').classList.remove('d-none');
    gameState.currentWord = gameState.customWord;
    gameState.currentLetterIndex = 0;
    
    // Update UI
    document.getElementById('currentWord').textContent = gameState.currentWord;
    document.getElementById('letterPosition').textContent = '1';
    document.getElementById('totalLetters').textContent = gameState.currentWord.length;
    
    // Create letter boxes
    createLetterBoxes('letterBoxes', gameState.currentWord);
}

function setupDesafioMode() {
    document.getElementById('desafioModeContent').classList.remove('d-none');
    loadNextChallengeWord();
}

function loadNextChallengeWord() {
    if (gameState.currentWordIndex >= Math.min(gameState.words.length, gameState.challengeWordsTotal)) {
        // Challenge completed
        stopGame();
        showAlert('Parab√©ns! Voc√™ completou o desafio!', 'success');
        return;
    }
    
    gameState.currentWord = gameState.words[gameState.currentWordIndex];
    gameState.currentLetterIndex = 0;
    
    // Update UI
    document.getElementById('challengeWord').textContent = gameState.currentWord;
    document.getElementById('challengeWordCount').textContent = gameState.currentWordIndex + 1;
    document.getElementById('totalChallengeWords').textContent = gameState.challengeWordsTotal;
    document.getElementById('challengeLetterPosition').textContent = '1';
    document.getElementById('challengeTotalLetters').textContent = gameState.currentWord.length;
    
    // Create letter boxes
    createLetterBoxes('challengeLetterBoxes', gameState.currentWord);
}

async function stopGame() {
    gameState.isActive = false;
    
    // Stop camera
    if (typeof CameraManager !== 'undefined') {
        CameraManager.stop();
    }
    
    // Stop timer
    if (gameState.timerInterval) {
        clearInterval(gameState.timerInterval);
    }
    
    // End session in backend
    await endGameSession();
    
    // Reset UI
    document.getElementById('startGameBtn').classList.remove('d-none');
    document.getElementById('stopGameBtn').classList.add('d-none');
    document.getElementById('gameContent').style.display = 'none';
    document.getElementById('timerCard').style.display = 'none';
    
    // Reset recognition display
    document.getElementById('recognitionResult').innerHTML = '<h3 class="text-muted">Jogo finalizado!</h3>';
    
    // Show final stats
    const finalStats = calculateFinalStats();
    showGameResults(finalStats);
}

function calculateFinalStats() {
    const accuracy = gameState.sessionStats.totalLetters > 0 
        ? Math.round((gameState.sessionStats.correctLetters / gameState.sessionStats.totalLetters) * 100)
        : 0;
    
    const timeElapsed = gameState.sessionStats.startTime 
        ? Math.floor((Date.now() - gameState.sessionStats.startTime) / 1000)
        : 0;
    
    return {
        mode: gameState.mode,
        wordsCompleted: gameState.sessionStats.wordsCompleted,
        lettersCompleted: gameState.sessionStats.correctLetters,
        totalLetters: gameState.sessionStats.totalLetters,
        accuracy: accuracy,
        timeElapsed: timeElapsed
    };
}

function showGameResults(stats) {
    const modeNames = {
        'normal': 'Reconhecimento Normal',
        'soletracao': 'Soletra√ß√£o',
        'desafio': 'Desafio'
    };
    
    let message = `<strong>Resultado - ${modeNames[stats.mode]}</strong><br>`;
    
    if (stats.mode !== 'normal') {
        message += `Palavras completadas: ${stats.wordsCompleted}<br>`;
        message += `Letras corretas: ${stats.lettersCompleted}/${stats.totalLetters}<br>`;
        message += `Precis√£o: ${stats.accuracy}%<br>`;
    }
    
    message += `Tempo de jogo: ${formatTime(stats.timeElapsed)}`;
    
    showAlert(message, 'info', 8000);
}

function formatTime(seconds) {
    const minutes = Math.floor(seconds / 60);
    const remainingSeconds = seconds % 60;
    return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
}

function loadNextWord() {
    if (gameState.currentWordIndex >= gameState.words.length) {
        // All words completed
        stopGame();
        showAlert('Parab√©ns! Voc√™ completou todas as palavras!', 'success');
        return;
    }
    
    gameState.currentWord = gameState.words[gameState.currentWordIndex];
    gameState.currentLetterIndex = 0;
    
    // Update UI
    document.getElementById('currentWord').textContent = gameState.currentWord;
    document.getElementById('letterPosition').textContent = '1';
    document.getElementById('totalLetters').textContent = gameState.currentWord.length;
    
    // Create letter boxes
    createLetterBoxes();
}

function createLetterBoxes(containerId, word) {
    const container = document.getElementById(containerId);
    container.innerHTML = '';
    
    for (let i = 0; i < word.length; i++) {
        const box = document.createElement('div');
        box.className = 'letter-box';
        if (i === gameState.currentLetterIndex) {
            box.classList.add('current');
        }
        box.textContent = word[i];
        container.appendChild(box);
    }
}

function updateLetterProgress(isCorrect) {
    let boxes, positionElement, totalElement;
    
    // Determine which elements to update based on mode
    if (gameState.mode === 'desafio') {
        boxes = document.querySelectorAll('#challengeLetterBoxes .letter-box');
        positionElement = document.getElementById('challengeLetterPosition');
        totalElement = document.getElementById('challengeTotalLetters');
    } else if (gameState.mode === 'soletracao') {
        boxes = document.querySelectorAll('#letterBoxes .letter-box');
        positionElement = document.getElementById('letterPosition');
        totalElement = document.getElementById('totalLetters');
    } else {
        // Normal mode doesn't have letter progression
        return;
    }
    
    const currentBox = boxes[gameState.currentLetterIndex];
    
    if (isCorrect) {
        currentBox.classList.remove('current');
        currentBox.classList.add('completed');
        
        gameState.currentLetterIndex++;
        gameState.sessionStats.correctLetters++;
        
        if (gameState.currentLetterIndex < gameState.currentWord.length) {
            // Move to next letter
            boxes[gameState.currentLetterIndex].classList.add('current');
            positionElement.textContent = gameState.currentLetterIndex + 1;
        } else {
            // Word completed
            gameState.sessionStats.wordsCompleted++;
            gameState.currentWordIndex++;
            updateSessionStats();
            
            setTimeout(() => {
                if (gameState.mode === 'desafio') {
                    loadNextChallengeWord();
                } else if (gameState.mode === 'soletracao') {
                    // Soletra√ß√£o mode ends after one word
                    stopGame();
                    showAlert('Palavra completada com sucesso!', 'success');
                }
            }, 1000);
        }
    } else {
        // Incorrect letter - show feedback
        currentBox.classList.add('incorrect');
        setTimeout(() => {
            currentBox.classList.remove('incorrect');
        }, 500);
    }
    
    gameState.sessionStats.totalLetters++;
    updateSessionStats();
}

function updateSessionStats() {
    const accuracy = gameState.sessionStats.totalLetters > 0 
        ? Math.round((gameState.sessionStats.correctLetters / gameState.sessionStats.totalLetters) * 100)
        : 0;
    
    document.getElementById('wordsCompleted').textContent = gameState.sessionStats.wordsCompleted;
    document.getElementById('accuracy').textContent = accuracy + '%';
    
    // Update time
    if (gameState.sessionStats.startTime) {
        const elapsed = Math.floor((Date.now() - gameState.sessionStats.startTime) / 1000);
        const minutes = Math.floor(elapsed / 60);
        const seconds = elapsed % 60;
        document.getElementById('totalTime').textContent = 
            `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }
}

function startTimer() {
    // Timer configuration based on difficulty and mode
    const timerConfigs = {
        'iniciante': { challenge_time: 180 },
        'intermediario': { challenge_time: 120 },
        'avancado': { challenge_time: 90 },
        'expert': { challenge_time: 60 }
    };
    
    const config = timerConfigs[gameState.difficulty] || timerConfigs['iniciante'];
    gameState.timeRemaining = config.challenge_time;
    updateTimerDisplay();
    
    gameState.timerInterval = setInterval(() => {
        gameState.timeRemaining--;
        updateTimerDisplay();
        
        if (gameState.timeRemaining <= 0) {
            stopGame();
            showAlert('Tempo esgotado!', 'warning');
        }
    }, 1000);
}

function updateTimerDisplay() {
    document.getElementById('timeRemaining').textContent = gameState.timeRemaining;
    
    // Update progress circle (only if timer is visible)
    const timerCard = document.getElementById('timerCard');
    if (timerCard.style.display !== 'none') {
        const circle = document.getElementById('progressCircle');
        const circumference = 314;
        
        // Get initial time based on difficulty
        const timerConfigs = {
            'iniciante': 180,
            'intermediario': 120, 
            'avancado': 90,
            'expert': 60
        };
        const initialTime = timerConfigs[gameState.difficulty] || 180;
        
        const progress = (initialTime - gameState.timeRemaining) / initialTime;
        const offset = circumference - (progress * circumference);
        circle.style.strokeDashoffset = offset;
        
        // Change color based on time remaining
        if (gameState.timeRemaining <= 10) {
            circle.style.stroke = '#dc3545';
        } else if (gameState.timeRemaining <= 30) {
            circle.style.stroke = '#ffc107';
        } else {
            circle.style.stroke = '#007bff';
        }
    }
}

async function startGameSession(sessionData) {
    try {
        const response = await fetch('/api/start_session', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(sessionData)
        });
        
        const data = await response.json();
        if (data.success) {
            gameState.sessionStats.sessionId = data.session_data.session_id;
        }
    } catch (error) {
        console.error('Erro ao iniciar sess√£o:', error);
    }
}

async function endGameSession() {
    try {
        const accuracy = gameState.sessionStats.totalLetters > 0 
            ? (gameState.sessionStats.correctLetters / gameState.sessionStats.totalLetters) * 100
            : 0;
        
        await fetch('/api/end_session', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                stats: {
                    words_completed: gameState.sessionStats.wordsCompleted,
                    total_letters: gameState.sessionStats.totalLetters,
                    correct_letters: gameState.sessionStats.correctLetters,
                    accuracy: accuracy
                }
            })
        });
    } catch (error) {
        console.error('Erro ao finalizar sess√£o:', error);
    }
}

// Export for camera module
window.gameState = gameState;
window.updateLetterProgress = updateLetterProgress;
</script>
{% endblock %}