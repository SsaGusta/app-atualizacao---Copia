{% extends "base.html" %}

{% block title %}Desafio LIBRAS - Contra o Tempo{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-lg-12">
            <!-- Header do Desafio -->
            <div class="text-center mb-4">
                <h1 class="display-4 text-warning mb-3">
                    <i class="fas fa-stopwatch"></i> Desafio LIBRAS
                </h1>
                <p class="lead">Faça o máximo de palavras no menor tempo possível!</p>
            </div>

            <!-- Seleção de Dificuldade -->
            <div id="difficultySelection" class="text-center mb-4">
                <h3 class="mb-4">Escolha seu Nível de Desafio</h3>
                <div class="row justify-content-center">
                    <div class="col-md-6 col-lg-8">
                        <div class="row">
                            <div class="col-6 col-md-3 mb-3">
                                <div class="card difficulty-card border-success" data-level="iniciante" data-time="180">
                                    <div class="card-body text-center p-3">
                                        <i class="fas fa-seedling fa-2x text-success mb-2"></i>
                                        <h6 class="card-title">Iniciante</h6>
                                        <p class="small text-muted mb-2">Palavras simples</p>
                                        <span class="badge bg-success">3 min</span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-6 col-md-3 mb-3">
                                <div class="card difficulty-card border-primary" data-level="intermediario" data-time="120">
                                    <div class="card-body text-center p-3">
                                        <i class="fas fa-chart-line fa-2x text-primary mb-2"></i>
                                        <h6 class="card-title">Intermediário</h6>
                                        <p class="small text-muted mb-2">Palavras médias</p>
                                        <span class="badge bg-primary">2 min</span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-6 col-md-3 mb-3">
                                <div class="card difficulty-card border-warning" data-level="avancado" data-time="90">
                                    <div class="card-body text-center p-3">
                                        <i class="fas fa-fire fa-2x text-warning mb-2"></i>
                                        <h6 class="card-title">Avançado</h6>
                                        <p class="small text-muted mb-2">Palavras complexas</p>
                                        <span class="badge bg-warning text-dark">1.5 min</span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-6 col-md-3 mb-3">
                                <div class="card difficulty-card border-danger" data-level="expert" data-time="60">
                                    <div class="card-body text-center p-3">
                                        <i class="fas fa-crown fa-2x text-danger mb-2"></i>
                                        <h6 class="card-title">Expert</h6>
                                        <p class="small text-muted mb-2">Frases completas</p>
                                        <span class="badge bg-danger">1 min</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Área do Jogo -->
            <div id="gameArea" class="d-none">
                <div class="row">
                    <!-- Painel Lateral Esquerdo -->
                    <div class="col-lg-3">
                        <div class="card mb-3">
                            <div class="card-header bg-info text-white">
                                <h6 class="mb-0"><i class="fas fa-info-circle"></i> Status do Desafio</h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="small text-muted">Nível:</label>
                                    <div id="currentLevel" class="fw-bold text-capitalize"></div>
                                </div>
                                <div class="mb-3">
                                    <label class="small text-muted">Tempo Restante:</label>
                                    <div id="timeRemaining" class="fw-bold fs-4 text-danger">00:00</div>
                                </div>
                                <div class="mb-3">
                                    <label class="small text-muted">Palavras Completadas:</label>
                                    <div id="wordsCompleted" class="fw-bold fs-5 text-success">0</div>
                                </div>
                                <div class="mb-3">
                                    <label class="small text-muted">Pontuação:</label>
                                    <div id="currentScore" class="fw-bold fs-5 text-warning">0</div>
                                </div>
                                <div class="progress mb-2">
                                    <div id="timeProgress" class="progress-bar bg-danger" role="progressbar" style="width: 100%"></div>
                                </div>
                                <button id="pauseBtn" class="btn btn-warning btn-sm w-100 mb-2">
                                    <i class="fas fa-pause"></i> Pausar
                                </button>
                                <button id="quitBtn" class="btn btn-outline-danger btn-sm w-100">
                                    <i class="fas fa-times"></i> Sair
                                </button>
                            </div>
                        </div>

                        <!-- Dicas -->
                        <div class="card">
                            <div class="card-header bg-light">
                                <h6 class="mb-0"><i class="fas fa-lightbulb"></i> Dicas</h6>
                            </div>
                            <div class="card-body">
                                <ul class="small mb-0" id="gameTips">
                                    <li>Mantenha boa iluminação</li>
                                    <li>Posicione as mãos na câmera</li>
                                    <li>Seja rápido e preciso</li>
                                    <li>Use o vídeo de ajuda se necessário</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- Área Central do Jogo -->
                    <div class="col-lg-6">
                        <div class="card mb-3">
                            <div class="card-header bg-primary text-white text-center">
                                <h5 class="mb-0" id="wordCardTitle">Palavra Atual</h5>
                            </div>
                            <div class="card-body text-center">
                                <div id="currentWord" class="current-word-display fw-bold text-primary mb-3">CASA</div>
                                <div id="currentProgress" class="mb-3">
                                    <span class="text-muted">Progresso:</span>
                                    <div id="wordProgress" class="word-progress-display"></div>
                                </div>
                                <div id="wordHints" class="small text-muted mb-3">
                                    Digite a palavra acima usando gestos LIBRAS
                                </div>
                                <button id="skipWordBtn" class="btn btn-outline-secondary btn-sm">
                                    <i class="fas fa-forward"></i> Pular Palavra (-5 pontos)
                                </button>
                            </div>
                        </div>

                        <!-- Área da Câmera -->
                        <div class="card">
                            <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                                <span><i class="fas fa-camera"></i> Câmera de Reconhecimento</span>
                                <div>
                                    <button id="toggleCameraBtn" class="btn btn-sm btn-outline-light me-2">
                                        <i class="fas fa-video"></i>
                                    </button>
                                    <button id="helpVideoBtn" class="btn btn-sm btn-info">
                                        <i class="fas fa-question-circle"></i> Ajuda
                                    </button>
                                </div>
                            </div>
                            <div class="card-body p-2">
                                <div class="position-relative">
                                    <video id="video" width="100%" height="400" autoplay muted style="border-radius: 8px; background: #000;"></video>
                                    <canvas id="canvas" width="640" height="480" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;"></canvas>
                                    <div id="cameraStatus" class="position-absolute top-0 start-0 m-2">
                                        <span class="badge bg-success">
                                            <i class="fas fa-circle"></i> Câmera Ativa
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Painel Lateral Direito -->
                    <div class="col-lg-3">
                        <div class="card mb-3">
                            <div class="card-header bg-success text-white">
                                <h6 class="mb-0"><i class="fas fa-list"></i> Próximas Palavras</h6>
                            </div>
                            <div class="card-body">
                                <div id="nextWords" class="small">
                                    <!-- Palavras serão inseridas via JavaScript -->
                                </div>
                            </div>
                        </div>

                        <div class="card mb-3">
                            <div class="card-header bg-warning text-dark">
                                <h6 class="mb-0"><i class="fas fa-hand-paper"></i> Última Letra</h6>
                            </div>
                            <div class="card-body text-center">
                                <div id="lastDetected" class="fs-1 fw-bold text-primary">-</div>
                                <div id="confidence" class="small text-muted">Aguardando...</div>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-header bg-secondary text-white">
                                <h6 class="mb-0"><i class="fas fa-trophy"></i> Ranking Atual</h6>
                            </div>
                            <div class="card-body">
                                <div id="currentRanking" class="small">
                                    Carregando ranking...
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Resultados Finais -->
            <div id="resultsArea" class="d-none">
                <div class="row justify-content-center">
                    <div class="col-md-8">
                        <div class="card border-success">
                            <div class="card-header bg-success text-white text-center">
                                <h4 class="mb-0"><i class="fas fa-flag-checkered"></i> Desafio Concluído!</h4>
                            </div>
                            <div class="card-body text-center">
                                <div class="row mb-4">
                                    <div class="col-md-4">
                                        <h5 class="text-muted">Nível</h5>
                                        <div id="finalLevel" class="fs-4 fw-bold text-capitalize"></div>
                                    </div>
                                    <div class="col-md-4">
                                        <h5 class="text-muted">Palavras</h5>
                                        <div id="finalWords" class="fs-4 fw-bold text-success"></div>
                                    </div>
                                    <div class="col-md-4">
                                        <h5 class="text-muted">Pontuação</h5>
                                        <div id="finalScore" class="fs-4 fw-bold text-warning"></div>
                                    </div>
                                </div>
                                
                                <div id="performanceMessage" class="alert alert-info mb-4">
                                    <i class="fas fa-star"></i> Excelente performance!
                                </div>

                                <div class="d-grid gap-2 d-md-block">
                                    <button id="playAgainBtn" class="btn btn-primary btn-lg me-md-2">
                                        <i class="fas fa-redo"></i> Jogar Novamente
                                    </button>
                                    <button id="changeLevel" class="btn btn-warning btn-lg me-md-2">
                                        <i class="fas fa-exchange-alt"></i> Mudar Nível
                                    </button>
                                    <a href="{{ url_for('statistics') }}" class="btn btn-outline-primary btn-lg">
                                        <i class="fas fa-chart-bar"></i> Ver Estatísticas
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal de Ajuda -->
            <div class="modal fade" id="helpModal" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">
                                <i class="fas fa-question-circle"></i> Como fazer: <span id="helpLetter"></span>
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body text-center">
                            <video id="helpVideo" width="100%" height="300" controls>
                                Seu navegador não suporta vídeos.
                            </video>
                            <p class="mt-3 text-muted">
                                Assista ao vídeo para ver como fazer o sinal da letra corretamente.
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal de Pausa -->
            <div class="modal fade" id="pauseModal" tabindex="-1" data-bs-backdrop="static">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header bg-warning text-dark">
                            <h5 class="modal-title">
                                <i class="fas fa-pause"></i> Jogo Pausado
                            </h5>
                        </div>
                        <div class="modal-body text-center">
                            <p>O cronômetro foi pausado. Clique em "Continuar" quando estiver pronto.</p>
                            <div class="d-grid gap-2">
                                <button id="resumeBtn" class="btn btn-success">
                                    <i class="fas fa-play"></i> Continuar
                                </button>
                                <button id="quitFromPause" class="btn btn-outline-danger">
                                    <i class="fas fa-times"></i> Sair do Desafio
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<style>
/* Estilos específicos para o modo Desafio */
.current-word-display {
    min-height: 120px;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
    border-radius: 10px;
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border: 2px solid #dee2e6;
    margin-bottom: 20px;
    transition: all 0.3s ease;
}

/* Estilos responsivos para diferentes níveis */
.current-word-display.level-iniciante {
    font-size: 4rem;
    font-weight: 800;
    letter-spacing: 0.2em;
}

.current-word-display.level-intermediario {
    font-size: 3.5rem;
    font-weight: 700;
    letter-spacing: 0.15em;
}

.current-word-display.level-avancado {
    font-size: 2.8rem;
    font-weight: 700;
    letter-spacing: 0.1em;
}

.current-word-display.level-expert {
    font-size: 1.8rem;
    font-weight: 600;
    line-height: 1.4;
    letter-spacing: 0.05em;
    text-align: center;
    padding: 25px;
    background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
    border: 2px solid #f39c12;
    color: #8b5a00;
    font-family: 'Georgia', 'Times New Roman', serif;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.word-progress-display {
    font-size: 1.5rem;
    font-weight: 600;
    min-height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-wrap: wrap;
    gap: 2px;
    padding: 10px;
    background-color: #f8f9fa;
    border-radius: 8px;
    border: 1px solid #dee2e6;
}

.word-progress-display.level-expert {
    font-size: 1.2rem;
    line-height: 1.6;
    min-height: 60px;
    padding: 15px;
    background: linear-gradient(135deg, #e8f5e8 0%, #d4edda 100%);
    border: 1px solid #c3e6cb;
}

/* Destaque para letra atual */
.current-letter-highlight {
    background-color: #ffc107 !important;
    color: #000 !important;
    padding: 2px 6px;
    border-radius: 4px;
    font-weight: bold;
    animation: pulse 1s infinite;
}

@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
}

/* Letra completada */
.completed-letter {
    color: #28a745 !important;
    font-weight: bold;
}

/* Espaços e hífens visuais */
.word-separator {
    color: #6c757d;
    font-weight: normal;
    margin: 0 4px;
}

/* Responsividade para telas menores */
@media (max-width: 768px) {
    .current-word-display.level-expert {
        font-size: 1.4rem;
        padding: 20px 15px;
    }
    
    .current-word-display.level-iniciante {
        font-size: 3rem;
    }
    
    .current-word-display.level-intermediario {
        font-size: 2.5rem;
    }
    
    .current-word-display.level-avancado {
        font-size: 2rem;
    }
}

@media (max-width: 576px) {
    .current-word-display.level-expert {
        font-size: 1.2rem;
        padding: 15px 10px;
        line-height: 1.3;
    }
}

/* Efeito de sucesso quando palavra é completada */
.word-completed-effect {
    background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%) !important;
    border-color: #28a745 !important;
    color: #155724 !important;
    transform: scale(1.02);
    box-shadow: 0 0 20px rgba(40, 167, 69, 0.3);
}
</style>

<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
<script src="{{ url_for('static', filename='js/backup/libras-recognizer.js') }}"></script>
<script>
class DesafioGame {
    constructor() {
        this.currentLevel = null;
        this.totalTime = 0;
        this.timeRemaining = 0;
        this.timer = null;
        this.isPaused = false;
        this.isGameActive = false;
        
        this.currentWord = '';
        this.currentWordIndex = 0;
        this.currentLetterIndex = 0;
        this.wordsCompleted = 0;
        this.currentScore = 0;
        this.wordsList = [];
        this.nextWordsList = [];
        
        this.gestureRecognizer = null;
        this.camera = null;
        this.hands = null;
        
        this.initializeElements();
        this.setupEventListeners();
    }
    
    initializeElements() {
        // Área de seleção
        this.difficultySelection = document.getElementById('difficultySelection');
        this.gameArea = document.getElementById('gameArea');
        this.resultsArea = document.getElementById('resultsArea');
        
        // Cards de dificuldade
        this.difficultyCards = document.querySelectorAll('.difficulty-card');
        
        // Elementos do jogo
        this.currentLevelEl = document.getElementById('currentLevel');
        this.timeRemainingEl = document.getElementById('timeRemaining');
        this.wordsCompletedEl = document.getElementById('wordsCompleted');
        this.currentScoreEl = document.getElementById('currentScore');
        this.timeProgressEl = document.getElementById('timeProgress');
        
        // Palavra atual
        this.currentWordEl = document.getElementById('currentWord');
        this.wordProgressEl = document.getElementById('wordProgress');
        this.wordHintsEl = document.getElementById('wordHints');
        
        // Câmera
        this.video = document.getElementById('video');
        this.canvas = document.getElementById('canvas');
        
        // Detecção
        this.lastDetectedEl = document.getElementById('lastDetected');
        this.confidenceEl = document.getElementById('confidence');
        
        // Próximas palavras
        this.nextWordsEl = document.getElementById('nextWords');
        
        // Botões
        this.pauseBtn = document.getElementById('pauseBtn');
        this.quitBtn = document.getElementById('quitBtn');
        this.skipWordBtn = document.getElementById('skipWordBtn');
        this.helpVideoBtn = document.getElementById('helpVideoBtn');
        this.playAgainBtn = document.getElementById('playAgainBtn');
        this.changeLevelBtn = document.getElementById('changeLevel');
        this.resumeBtn = document.getElementById('resumeBtn');
        this.quitFromPauseBtn = document.getElementById('quitFromPause');
        
        // Resultados
        this.finalLevelEl = document.getElementById('finalLevel');
        this.finalWordsEl = document.getElementById('finalWords');
        this.finalScoreEl = document.getElementById('finalScore');
        this.performanceMessageEl = document.getElementById('performanceMessage');
        
        // Modais
        this.helpModal = new bootstrap.Modal(document.getElementById('helpModal'));
        this.pauseModal = new bootstrap.Modal(document.getElementById('pauseModal'));
    }
    
    setupEventListeners() {
        // Seleção de dificuldade
        this.difficultyCards.forEach(card => {
            card.addEventListener('click', () => {
                const level = card.dataset.level;
                const time = parseInt(card.dataset.time);
                this.startGame(level, time);
            });
            
            card.addEventListener('mouseenter', () => {
                card.style.transform = 'scale(1.05)';
            });
            
            card.addEventListener('mouseleave', () => {
                card.style.transform = 'scale(1)';
            });
        });
        
        // Botões do jogo
        this.pauseBtn.addEventListener('click', () => this.pauseGame());
        this.quitBtn.addEventListener('click', () => this.quitGame());
        this.skipWordBtn.addEventListener('click', () => this.skipWord());
        this.helpVideoBtn.addEventListener('click', () => this.showHelp());
        
        // Botões de pausa
        this.resumeBtn.addEventListener('click', () => this.resumeGame());
        this.quitFromPauseBtn.addEventListener('click', () => this.quitGame());
        
        // Botões de resultado
        this.playAgainBtn.addEventListener('click', () => this.playAgain());
        this.changeLevelBtn.addEventListener('click', () => this.changeLevel());
    }
    
    async startGame(level, timeInSeconds) {
        this.currentLevel = level;
        this.totalTime = timeInSeconds;
        this.timeRemaining = timeInSeconds;
        this.wordsCompleted = 0;
        this.currentScore = 0;
        this.currentWordIndex = 0;
        this.currentLetterIndex = 0;
        
        // Carrega palavras do nível
        await this.loadWordsForLevel(level);
        
        // Configura interface
        this.currentLevelEl.textContent = level;
        this.updateGameStats();
        this.updateGameTips(level);
        this.updateHelpButtonVisibility(level);
        
        // Esconder seleção, mostrar jogo
        this.difficultySelection.classList.add('d-none');
        this.gameArea.classList.remove('d-none');
        
        // Inicializa câmera e reconhecimento
        await this.initializeCamera();
        await this.initializeGestureRecognition();
        
        // Configura primeira palavra
        this.setupNextWord();
        
        // Inicia timer
        this.startTimer();
        this.isGameActive = true;
        
        console.log(`Desafio iniciado - Nível: ${level}, Tempo: ${timeInSeconds}s`);
    }
    
    async loadWordsForLevel(level) {
        try {
            const response = await fetch(`/api/get_challenge_words/${level}`);
            const data = await response.json();
            this.wordsList = data.words;
            this.shuffleArray(this.wordsList);
            this.updateNextWordsList();
        } catch (error) {
            console.error('Erro ao carregar palavras:', error);
            // Fallback words
            this.wordsList = ['CASA', 'GATO', 'AGUA', 'LIVRO', 'AMIGO'];
        }
    }
    
    shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
    }
    
    setupNextWord() {
        if (this.currentWordIndex >= this.wordsList.length) {
            // Se acabaram as palavras, embaralha novamente
            this.shuffleArray(this.wordsList);
            this.currentWordIndex = 0;
        }
        
        this.currentWord = this.wordsList[this.currentWordIndex];
        this.currentLetterIndex = 0;
        
        // Atualiza título do card baseado no nível
        const wordCardTitle = document.getElementById('wordCardTitle');
        if (this.currentLevel === 'expert') {
            wordCardTitle.textContent = 'Frase Atual';
        } else {
            wordCardTitle.textContent = 'Palavra Atual';
        }
        
        // Aplica classe CSS baseada no nível
        this.currentWordEl.className = `current-word-display fw-bold text-primary mb-3 level-${this.currentLevel}`;
        this.currentWordEl.textContent = this.currentWord;
        
        // Aplica classe CSS no progresso baseada no nível
        this.wordProgressEl.className = `word-progress-display level-${this.currentLevel}`;
        
        this.updateWordProgress();
        this.updateNextWordsList();
        
        // Atualiza dicas
        this.updateWordHints();
    }
    
    updateWordProgress() {
        const letters = this.currentWord.split('');
        let progressHtml = '';
        let wordCount = 0;
        
        letters.forEach((letter, index) => {
            if (letter === ' ') {
                progressHtml += '<span class="word-separator">|</span>';
                wordCount++;
                // Quebra de linha a cada 5 palavras no modo expert
                if (this.currentLevel === 'expert' && wordCount % 5 === 0) {
                    progressHtml += '<br>';
                }
                return;
            }
            if (letter === '-') {
                progressHtml += '<span class="word-separator">-</span>';
                return;
            }
            
            if (index < this.currentLetterIndex) {
                progressHtml += `<span class="completed-letter">${letter}</span>`;
            } else if (index === this.currentLetterIndex) {
                progressHtml += `<span class="current-letter-highlight">${letter}</span>`;
            } else {
                progressHtml += `<span class="text-muted">${letter}</span>`;
            }
        });
        
        this.wordProgressEl.innerHTML = progressHtml;
    }
    
    updateWordHints() {
        const currentLetter = this.getCurrentLetter();
        if (currentLetter && currentLetter !== ' ' && currentLetter !== '-') {
            if (this.currentLevel === 'expert') {
                this.wordHintsEl.innerHTML = `
                    <i class="fas fa-hand-paper text-primary"></i> 
                    Faça o sinal da letra: <strong class="fs-6 text-dark">${currentLetter}</strong>
                    <br><small class="text-muted"><i class="fas fa-graduation-cap"></i> Modo avançado - sem assistência</small>
                `;
            } else if (this.currentLevel === 'iniciante') {
                this.wordHintsEl.innerHTML = `
                    Faça o sinal da letra: <strong>${currentLetter}</strong>
                    <br><small class="text-muted"><i class="fas fa-video"></i> Clique em "Ajuda" para ver o vídeo</small>
                `;
            } else {
                // Intermediário e Avançado
                this.wordHintsEl.innerHTML = `
                    <i class="fas fa-hand-paper text-primary"></i> 
                    Faça o sinal da letra: <strong>${currentLetter}</strong>
                    <br><small class="text-muted"><i class="fas fa-graduation-cap"></i> Modo ${this.currentLevel} - sem assistência</small>
                `;
            }
        } else {
            if (this.currentLevel === 'expert') {
                this.wordHintsEl.innerHTML = '<i class="fas fa-forward text-success"></i> Continue soletrando a frase...';
            } else {
                this.wordHintsEl.textContent = 'Continue soletrando a palavra...';
            }
        }
    }
    
    getCurrentLetter() {
        if (this.currentLetterIndex < this.currentWord.length) {
            return this.currentWord[this.currentLetterIndex];
        }
        return null;
    }
    
    updateNextWordsList() {
        const nextWords = this.wordsList.slice(this.currentWordIndex + 1, this.currentWordIndex + 6);
        this.nextWordsEl.innerHTML = nextWords.map((word, index) => 
            `<div class="mb-1"><span class="badge bg-light text-dark me-1">${index + 1}</span>${word}</div>`
        ).join('');
    }
    
    startTimer() {
        this.timer = setInterval(() => {
            if (!this.isPaused && this.isGameActive) {
                this.timeRemaining--;
                this.updateTimeDisplay();
                
                if (this.timeRemaining <= 0) {
                    this.endGame();
                }
            }
        }, 1000);
    }
    
    updateTimeDisplay() {
        const minutes = Math.floor(this.timeRemaining / 60);
        const seconds = this.timeRemaining % 60;
        this.timeRemainingEl.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        
        // Atualiza barra de progresso
        const progress = (this.timeRemaining / this.totalTime) * 100;
        this.timeProgressEl.style.width = `${progress}%`;
        
        // Muda cor quando tempo está acabando
        if (this.timeRemaining <= 30) {
            this.timeProgressEl.classList.remove('bg-warning');
            this.timeProgressEl.classList.add('bg-danger');
            this.timeRemainingEl.classList.add('text-danger');
        } else if (this.timeRemaining <= 60) {
            this.timeProgressEl.classList.remove('bg-success');
            this.timeProgressEl.classList.add('bg-warning');
            this.timeRemainingEl.classList.add('text-warning');
        }
    }
    
    updateGameTips(level) {
        const gameTips = document.getElementById('gameTips');
        if (level === 'expert') {
            gameTips.innerHTML = `
                <li><i class="fas fa-lightbulb text-warning"></i> Leia toda a frase antes de começar</li>
                <li><i class="fas fa-eye text-info"></i> Mantenha boa iluminação</li>
                <li><i class="fas fa-hand-paper text-primary"></i> Posicione as mãos na câmera</li>
                <li><i class="fas fa-clock text-danger"></i> Seja rápido mas preciso</li>
                <li><i class="fas fa-graduation-cap text-secondary"></i> Sem assistência de vídeo</li>
                <li><i class="fas fa-space-shuttle text-secondary"></i> Espaços são inseridos automaticamente</li>
            `;
        } else if (level === 'iniciante') {
            gameTips.innerHTML = `
                <li><i class="fas fa-eye text-info"></i> Mantenha boa iluminação</li>
                <li><i class="fas fa-hand-paper text-primary"></i> Posicione as mãos na câmera</li>
                <li><i class="fas fa-clock text-success"></i> Seja rápido e preciso</li>
                <li><i class="fas fa-video text-warning"></i> Use o botão "Ajuda" para ver vídeos</li>
                <li><i class="fas fa-heart text-danger"></i> Não desista, pratique!</li>
            `;
        } else {
            // Intermediário e Avançado
            gameTips.innerHTML = `
                <li><i class="fas fa-eye text-info"></i> Mantenha boa iluminação</li>
                <li><i class="fas fa-hand-paper text-primary"></i> Posicione as mãos na câmera</li>
                <li><i class="fas fa-clock text-danger"></i> Seja rápido e preciso</li>
                <li><i class="fas fa-graduation-cap text-secondary"></i> Sem assistência de vídeo</li>
                <li><i class="fas fa-trophy text-warning"></i> Confie no seu conhecimento</li>
            `;
        }
    }
    
    updateHelpButtonVisibility(level) {
        // Mostrar botão de ajuda apenas no nível iniciante
        if (level === 'iniciante') {
            this.helpVideoBtn.style.display = 'inline-block';
            this.helpVideoBtn.classList.remove('d-none');
        } else {
            this.helpVideoBtn.style.display = 'none';
            this.helpVideoBtn.classList.add('d-none');
        }
    }
    
    updateGameStats() {
        this.wordsCompletedEl.textContent = this.wordsCompleted;
        this.currentScoreEl.textContent = this.currentScore;
    }
    
    pauseGame() {
        this.isPaused = true;
        this.pauseModal.show();
    }
    
    resumeGame() {
        this.isPaused = false;
        this.pauseModal.hide();
    }
    
    quitGame() {
        this.isGameActive = false;
        if (this.timer) {
            clearInterval(this.timer);
        }
        this.showResults();
    }
    
    skipWord() {
        this.currentScore = Math.max(0, this.currentScore - 5);
        this.currentWordIndex++;
        this.setupNextWord();
        this.updateGameStats();
    }
    
    showHelp() {
        // Só permite ajuda no nível iniciante
        if (this.currentLevel !== 'iniciante') {
            return;
        }
        
        const currentLetter = this.getCurrentLetter();
        if (currentLetter && currentLetter !== ' ' && currentLetter !== '-') {
            document.getElementById('helpLetter').textContent = currentLetter;
            document.getElementById('helpVideo').src = `/videos/${currentLetter}`;
            this.helpModal.show();
        }
    }
    
    processGestureResult(letter, confidence) {
        this.lastDetectedEl.textContent = letter || '-';
        this.confidenceEl.textContent = confidence ? `${Math.round(confidence * 100)}%` : 'Aguardando...';
        
        if (!this.isGameActive || this.isPaused) return;
        
        const expectedLetter = this.getCurrentLetter();
        
        if (letter && expectedLetter && letter === expectedLetter) {
            this.advanceLetter();
        }
    }
    
    advanceLetter() {
        this.currentLetterIndex++;
        
        // Pula espaços e hífens automaticamente
        while (this.currentLetterIndex < this.currentWord.length) {
            const letter = this.currentWord[this.currentLetterIndex];
            if (letter !== ' ' && letter !== '-') {
                break;
            }
            this.currentLetterIndex++;
        }
        
        this.updateWordProgress();
        this.updateWordHints();
        
        // Verifica se completou a palavra
        if (this.currentLetterIndex >= this.currentWord.length) {
            this.completeWord();
        }
    }
    
    completeWord() {
        this.wordsCompleted++;
        
        // Calcula pontuação baseada no tamanho da palavra e tempo restante
        const wordLength = this.currentWord.replace(/[\s-]/g, '').length;
        const timeBonus = Math.floor(this.timeRemaining / 10);
        const wordScore = wordLength * 10 + timeBonus;
        this.currentScore += wordScore;
        
        this.updateGameStats();
        
        // Próxima palavra
        this.currentWordIndex++;
        this.setupNextWord();
        
        // Feedback visual
        this.showWordCompletedFeedback();
    }
    
    showWordCompletedFeedback() {
        // Adiciona efeito visual de sucesso
        this.currentWordEl.classList.add('word-completed-effect');
        
        // Remove o efeito após animação
        setTimeout(() => {
            this.currentWordEl.classList.remove('word-completed-effect');
        }, 800);
        
        // Efeito adicional no progresso
        this.wordProgressEl.style.transform = 'scale(1.05)';
        setTimeout(() => {
            this.wordProgressEl.style.transform = 'scale(1)';
        }, 300);
    }
    
    endGame() {
        this.isGameActive = false;
        if (this.timer) {
            clearInterval(this.timer);
        }
        this.saveGameResults();
        this.showResults();
    }
    
    async saveGameResults() {
        try {
            const data = {
                level: this.currentLevel,
                words_completed: this.wordsCompleted,
                score: this.currentScore,
                time_taken: this.totalTime - this.timeRemaining
            };
            
            await fetch('/api/save_challenge_result', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });
        } catch (error) {
            console.error('Erro ao salvar resultado:', error);
        }
    }
    
    showResults() {
        this.gameArea.classList.add('d-none');
        this.resultsArea.classList.remove('d-none');
        
        this.finalLevelEl.textContent = this.currentLevel;
        this.finalWordsEl.textContent = this.wordsCompleted;
        this.finalScoreEl.textContent = this.currentScore;
        
        // Mensagem de performance
        let message = '';
        if (this.wordsCompleted >= 20) {
            message = '<i class="fas fa-crown"></i> Performance Excepcional! Você é um mestre em LIBRAS!';
            this.performanceMessageEl.className = 'alert alert-success mb-4';
        } else if (this.wordsCompleted >= 15) {
            message = '<i class="fas fa-star"></i> Excelente performance! Continue praticando!';
            this.performanceMessageEl.className = 'alert alert-info mb-4';
        } else if (this.wordsCompleted >= 10) {
            message = '<i class="fas fa-thumbs-up"></i> Bom trabalho! Você está melhorando!';
            this.performanceMessageEl.className = 'alert alert-warning mb-4';
        } else {
            message = '<i class="fas fa-heart"></i> Continue praticando! Cada tentativa é um progresso!';
            this.performanceMessageEl.className = 'alert alert-primary mb-4';
        }
        
        this.performanceMessageEl.innerHTML = message;
    }
    
    playAgain() {
        this.resetGame();
        this.startGame(this.currentLevel, this.totalTime);
    }
    
    changeLevel() {
        this.resetGame();
        this.resultsArea.classList.add('d-none');
        this.difficultySelection.classList.remove('d-none');
    }
    
    resetGame() {
        if (this.timer) {
            clearInterval(this.timer);
        }
        
        this.isGameActive = false;
        this.isPaused = false;
        this.currentWordIndex = 0;
        this.currentLetterIndex = 0;
        this.wordsCompleted = 0;
        this.currentScore = 0;
        
        this.timeProgressEl.style.width = '100%';
        this.timeProgressEl.className = 'progress-bar bg-success';
        this.timeRemainingEl.className = 'fw-bold fs-4 text-danger';
        
        // Resetar visibilidade do botão de ajuda
        this.helpVideoBtn.style.display = 'inline-block';
        this.helpVideoBtn.classList.remove('d-none');
    }
    
    async initializeCamera() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ 
                video: { width: 640, height: 480 } 
            });
            this.video.srcObject = stream;
            
            this.camera = new Camera(this.video, {
                onFrame: async () => {
                    if (this.hands) {
                        await this.hands.send({ image: this.video });
                    }
                },
                width: 640,
                height: 480
            });
            
            await this.camera.start();
        } catch (error) {
            console.error('Erro ao inicializar câmera:', error);
        }
    }
    
    async initializeGestureRecognition() {
        try {
            // Usar o reconhecedor existente do sistema
            this.gestureRecognizer = window.LibrasRecognizer || null;
            
            this.hands = new Hands({
                locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
            });
            
            this.hands.setOptions({
                maxNumHands: 1,
                modelComplexity: 1,
                minDetectionConfidence: 0.5,
                minTrackingConfidence: 0.5
            });
            
            this.hands.onResults((results) => {
                this.onHandsResults(results);
            });
        } catch (error) {
            console.error('Erro ao inicializar reconhecimento:', error);
        }
    }
    
    onHandsResults(results) {
        const ctx = this.canvas.getContext('2d');
        ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
        
        if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
            const landmarks = results.multiHandLandmarks[0];
            
            // Desenha landmarks
            if (window.drawLandmarks && window.drawConnectors && window.HAND_CONNECTIONS) {
                drawLandmarks(ctx, landmarks, { color: '#00FF00', radius: 2 });
                drawConnectors(ctx, landmarks, HAND_CONNECTIONS, { color: '#00FF00', lineWidth: 1 });
            }
            
            // Reconhece gesto usando o sistema existente
            if (this.gestureRecognizer && typeof this.gestureRecognizer.recognizeGesture === 'function') {
                const result = this.gestureRecognizer.recognizeGesture(landmarks);
                this.processGestureResult(result.letter, result.confidence);
            } else {
                // Fallback - usar API do servidor
                this.recognizeGestureViaAPI(landmarks);
            }
        }
    }
    
    async recognizeGestureViaAPI(landmarks) {
        try {
            const response = await fetch('/api/recognize_gesture', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ landmarks: landmarks })
            });
            
            if (response.ok) {
                const result = await response.json();
                this.processGestureResult(result.letter, result.confidence);
            }
        } catch (error) {
            console.error('Erro no reconhecimento via API:', error);
        }
    }
}

// Inicializa o jogo quando a página carrega
document.addEventListener('DOMContentLoaded', function() {
    window.desafioGame = new DesafioGame();
});
</script>
{% endblock %}