{% extends "base.html" %}

{% block title %}Reconhecimento de Mãos - MediaPipe{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-10 mx-auto">
        <!-- Header -->
        <div class="text-center mb-4">
            <h1 class="text-primary">
                <i class="fas fa-hands"></i> Reconhecimento de Mãos
            </h1>
            <p class="lead">Detecção em tempo real usando MediaPipe</p>
        </div>

        <!-- Video/Camera Container -->
        <div class="card shadow-sm mb-4">
            <div class="card-body text-center">
                <div class="video-container position-relative d-inline-block">
                    <video id="input_video" style="display: none;" playsinline></video>
                    <canvas id="output_canvas" class="border rounded" style="max-width: 100%; height: auto;"></canvas>
                </div>
                <!-- Controls -->
                <div class="mt-3 mediapipe-controls">
                    <button id="start_button" class="btn btn-primary btn-lg me-2">
                        <i class="fas fa-play"></i> Iniciar Câmera
                    </button>
                    <button id="stop_button" class="btn btn-danger btn-lg" disabled>
                        <i class="fas fa-stop"></i> Parar Câmera
                    </button>
                </div>
                <!-- Status -->
                <div class="mt-3">
                    <div class="alert alert-info" role="alert">
                        <strong>Status:</strong> <span id="status">Aguardando...</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Game Stats and Progress -->
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-info-circle"></i> Informações</h5>
                    </div>
                    <div class="card-body">
                        <div id="hand_count" class="mb-2">
                            <strong>Mãos detectadas:</strong> 0
                        </div>
                        <div id="fps_counter">
                            <strong>FPS:</strong> -
                        </div>
                        <div class="mt-3">
                            <strong>Letra Detectada:</strong> <span id="detectedLetter" style="font-size: 1.2em; color: #28a745; transition: all 0.2s ease-in-out;" title="Passe o mouse para ver detalhes">-</span>
                        </div>
                        <div class="mt-2" id="gestureStatus" style="font-size: 0.9em;">
                            <strong>Gestos:</strong> Carregando...
                        </div>
                        <div class="mt-2">
                            <button id="refreshGesturesBtn" class="btn btn-sm btn-outline-primary" onclick="window.handTracker?.refreshGestures()" title="Recarregar gestos do servidor">
                                <i class="fas fa-sync-alt"></i> Atualizar Gestos
                            </button>
                        </div>
                        <div class="mt-2" id="recognitionDetails" style="font-size: 0.85em; color: #6c757d; display: none;">
                            <div><strong>Análise:</strong> <span id="analysisInfo">-</span></div>
                        </div>
                        <div class="mt-2" id="pointLegend" style="font-size: 0.8em; line-height: 1.3; display: none;">
                            <strong>Legenda dos pontos:</strong><br>
                            <span style="color: #00FF00;">●</span> Excelente 
                            <span style="color: #90EE90;">●</span> Bom 
                            <span style="color: #FFA500;">●</span> Aceitável 
                            <span style="color: #FF4444;">●</span> Ruim
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-hand-paper"></i> Pontos das Mãos</h5>
                    </div>
                    <div class="card-body">
                        <div id="hand_landmarks" style="max-height: 200px; overflow-y: auto;">
                            <p class="text-muted">Nenhuma mão detectada</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Instructions -->
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-lightbulb"></i> Instruções</h5>
            </div>
            <div class="card-body">
                <ul class="mb-0">
                    <li>Clique em "Iniciar Câmera" para começar</li>
                    <li>Permita o acesso à câmera quando solicitado</li>
                    <li>Posicione suas mãos na frente da câmera</li>
                    <li>O sistema detectará até 2 mãos simultaneamente</li>
                    <li>Os pontos vermelhos mostram os marcos das mãos</li>
                    <li>As linhas verdes conectam os pontos para formar a estrutura da mão</li>
                </ul>
            </div>
        </div>

        <!-- Navigation -->
        <div class="text-center mt-4">
            <a href="{{ url_for('index') }}" class="btn btn-outline-primary">
                <i class="fas fa-arrow-left"></i> Voltar ao Início
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- MediaPipe Dependencies -->
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>

<!-- Custom MediaPipe Scripts -->
<script src="{{ url_for('static', filename='js/main.js') }}"></script>
<script src="{{ url_for('static', filename='js/mediapipe-hands.js') }}"></script>

<script>
// Inicialização simplificada - apenas MediaPipe
window.addEventListener('load', function() {
    console.log('Página carregada - iniciando MediaPipe Hand Tracking');
    
    // Aguardar carregamento das bibliotecas MediaPipe
    setTimeout(() => {
        console.log('Verificando dependências MediaPipe...');
        console.log('Camera disponível:', typeof Camera !== 'undefined');
        console.log('Hands disponível:', typeof Hands !== 'undefined');
        console.log('drawConnectors disponível:', typeof drawConnectors !== 'undefined');
        console.log('drawLandmarks disponível:', typeof drawLandmarks !== 'undefined');
        
        // Inicializar HandTracker
        if (typeof HandTracker !== 'undefined' && document.getElementById('output_canvas')) {
            console.log('Inicializando HandTracker...');
            try {
                window.handTracker = new HandTracker();
                console.log('✅ HandTracker inicializado com sucesso');
                
                const statusElement = document.getElementById('status');
                if (statusElement) {
                    statusElement.textContent = 'Sistema pronto - clique em "Iniciar Câmera"';
                }
                
            } catch (error) {
                console.error('❌ Erro ao inicializar HandTracker:', error);
                const statusElement = document.getElementById('status');
                if (statusElement) {
                    statusElement.textContent = 'Erro na inicialização: ' + error.message;
                }
            }
        } else {
            console.error('❌ Dependências não disponíveis');
        }
        
    }, 1500);
});
</script>
{% endblock %}