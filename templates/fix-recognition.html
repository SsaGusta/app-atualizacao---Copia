<!DOCTYPE html>
<html>
<head>
    <title>ğŸ”§ Ajustar ConfiguraÃ§Ãµes de Reconhecimento</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .config-section { background: #e9ecef; padding: 20px; margin: 15px 0; border-radius: 8px; border-left: 4px solid #007bff; }
        .success { color: #28a745; font-weight: bold; }
        .error { color: #dc3545; font-weight: bold; }
        .warning { color: #ffc107; font-weight: bold; }
        button { padding: 12px 20px; margin: 8px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { background: #0056b3; }
        .slider-container { margin: 15px 0; }
        .slider { width: 100%; }
        .current-value { font-size: 18px; font-weight: bold; color: #007bff; }
        #output { background: #f8f9fa; padding: 15px; border-radius: 5px; margin: 15px 0; white-space: pre-wrap; max-height: 300px; overflow-y: auto; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ Ajustar ConfiguraÃ§Ãµes de Reconhecimento</h1>
        <p>Se a letra A nÃ£o estÃ¡ sendo reconhecida, vocÃª pode ajustar os parÃ¢metros aqui.</p>
        
        <div class="config-section">
            <h3>âš–ï¸ Threshold de ConfianÃ§a</h3>
            <p>Quanto menor, mais "tolerante" o sistema fica (mais fÃ¡cil reconhecer)</p>
            
            <div class="slider-container">
                <label for="confidenceSlider">ConfianÃ§a mÃ­nima: <span id="confidenceValue" class="current-value">75%</span></label>
                <input type="range" id="confidenceSlider" class="slider" min="40" max="95" value="75" 
                       oninput="updateConfidenceValue(this.value)">
            </div>
            
            <p><strong>RecomendaÃ§Ãµes:</strong></p>
            <ul>
                <li>ğŸŸ¢ <strong>60-70%:</strong> Mais tolerante (recomendado para testes)</li>
                <li>ğŸŸ¡ <strong>75-80%:</strong> Balanceado (padrÃ£o atual)</li>
                <li>ğŸ”´ <strong>85-95%:</strong> Muito rigoroso (pode nÃ£o reconhecer nada)</li>
            </ul>
            
            <button onclick="testWithCurrentThreshold()">ğŸ§ª Testar com Threshold Atual</button>
            <button onclick="findOptimalThreshold()">ğŸ¯ Encontrar Threshold Ideal</button>
        </div>
        
        <div class="config-section">
            <h3>ğŸ”„ Estabilidade</h3>
            <p>Quantos frames seguidos o sistema precisa detectar a letra para confirmar</p>
            
            <div class="slider-container">
                <label for="stabilitySlider">Frames para estabilidade: <span id="stabilityValue" class="current-value">3</span></label>
                <input type="range" id="stabilitySlider" class="slider" min="1" max="10" value="3" 
                       oninput="updateStabilityValue(this.value)">
            </div>
            
            <button onclick="testStability()">ğŸ”„ Testar Estabilidade</button>
        </div>
        
        <div class="config-section">
            <h3>ğŸš€ AÃ§Ãµes RÃ¡pidas</h3>
            <button onclick="setEasyMode()">ğŸ˜Š Modo FÃ¡cil (60% threshold)</button>
            <button onclick="setNormalMode()">ğŸ˜ Modo Normal (75% threshold)</button>
            <button onclick="setHardMode()">ğŸ˜¤ Modo DifÃ­cil (85% threshold)</button>
        </div>
        
        <div class="config-section">
            <h3>ğŸ¯ DiagnÃ³stico EspecÃ­fico da Letra A</h3>
            <button onclick="diagnoseLetterA()">ğŸ” Diagnosticar Letra A</button>
            <button onclick="testLetterAWithVariations()">ğŸ² Testar A com VariaÃ§Ãµes</button>
            <button onclick="simulateGameScenario()">ğŸ® Simular CenÃ¡rio do Jogo</button>
        </div>
        
        <div id="output">Clique em um botÃ£o para comeÃ§ar os testes...</div>
    </div>

    <script src="/static/js/custom-gesture-recognizer.js"></script>
    <script>
        const output = document.getElementById('output');
        let recognizer = null;
        
        function log(message) {
            output.textContent += new Date().toLocaleTimeString() + ': ' + message + '\n';
            output.scrollTop = output.scrollHeight;
        }
        
        function clearOutput() {
            output.textContent = '';
        }
        
        function updateConfidenceValue(value) {
            document.getElementById('confidenceValue').textContent = value + '%';
        }
        
        function updateStabilityValue(value) {
            document.getElementById('stabilityValue').textContent = value;
        }
        
        async function initRecognizer() {
            if (!recognizer) {
                recognizer = new CustomGestureRecognizer();
                await new Promise(resolve => setTimeout(resolve, 2000));
            }
            return recognizer;
        }
        
        async function testWithCurrentThreshold() {
            clearOutput();
            const thresholdValue = document.getElementById('confidenceSlider').value / 100;
            
            log(`ğŸ§ª Testando com threshold: ${(thresholdValue * 100).toFixed(0)}%`);
            
            await initRecognizer();
            
            // Modificar threshold temporariamente
            const originalThreshold = recognizer.confidenceThreshold;
            recognizer.confidenceThreshold = thresholdValue;
            
            try {
                // Buscar letra A
                const response = await fetch('/api/get_gestures');
                const gestures = await response.json();
                
                if (!gestures.A) {
                    log('âŒ Letra A nÃ£o foi capturada ainda!');
                    log('ğŸ’¡ VÃ¡ para /admin e capture a letra A primeiro');
                    return;
                }
                
                log('âœ… Letra A encontrada no banco');
                
                // Testar reconhecimento
                const result = await recognizer.recognizeLetter(gestures.A.landmarks);
                
                if (result && result.letter === 'A') {
                    log(`âœ… SUCESSO! Letra A reconhecida com ${(result.confidence * 100).toFixed(1)}% de confianÃ§a`);
                    log('ğŸ’¡ Este threshold funciona! Use-o no jogo.');
                } else if (result) {
                    log(`âš ï¸ Reconheceu '${result.letter}' ao invÃ©s de 'A' (${(result.confidence * 100).toFixed(1)}%)`);
                } else {
                    log('âŒ Nenhuma letra reconhecida com este threshold');
                    log('ğŸ’¡ Tente diminuir o threshold ou recapturar a letra A');
                }
                
            } finally {
                // Restaurar threshold original
                recognizer.confidenceThreshold = originalThreshold;
            }
        }
        
        async function findOptimalThreshold() {
            clearOutput();
            log('ğŸ¯ Procurando threshold ideal para a letra A...');
            
            await initRecognizer();
            
            const response = await fetch('/api/get_gestures');
            const gestures = await response.json();
            
            if (!gestures.A) {
                log('âŒ Letra A nÃ£o disponÃ­vel');
                return;
            }
            
            const testThresholds = [0.4, 0.5, 0.6, 0.65, 0.7, 0.75, 0.8, 0.85, 0.9, 0.95];
            let bestThreshold = null;
            
            for (const threshold of testThresholds) {
                recognizer.confidenceThreshold = threshold;
                
                const result = await recognizer.recognizeLetter(gestures.A.landmarks);
                
                if (result && result.letter === 'A') {
                    log(`âœ… ${(threshold * 100).toFixed(0)}%: APROVADO (confianÃ§a: ${(result.confidence * 100).toFixed(1)}%)`);
                    if (!bestThreshold) bestThreshold = threshold;
                } else {
                    log(`âŒ ${(threshold * 100).toFixed(0)}%: REPROVADO`);
                }
            }
            
            if (bestThreshold) {
                log(`\nğŸ‰ THRESHOLD IDEAL ENCONTRADO: ${(bestThreshold * 100).toFixed(0)}%`);
                log('ğŸ’¡ Ajuste o slider para este valor e teste no jogo!');
                
                // Atualizar slider
                document.getElementById('confidenceSlider').value = bestThreshold * 100;
                updateConfidenceValue(bestThreshold * 100);
            } else {
                log('\nâŒ Nenhum threshold funcionou!');
                log('ğŸ’¡ Problemas possÃ­veis:');
                log('   - Letra A foi capturada com qualidade muito baixa');
                log('   - Algoritmo de similaridade precisa ajuste');
                log('   - Landmarks corrompidos');
            }
        }
        
        async function setEasyMode() {
            document.getElementById('confidenceSlider').value = 60;
            updateConfidenceValue(60);
            await testWithCurrentThreshold();
        }
        
        async function setNormalMode() {
            document.getElementById('confidenceSlider').value = 75;
            updateConfidenceValue(75);
            await testWithCurrentThreshold();
        }
        
        async function setHardMode() {
            document.getElementById('confidenceSlider').value = 85;
            updateConfidenceValue(85);
            await testWithCurrentThreshold();
        }
        
        async function testStability() {
            clearOutput();
            const stabilityFrames = parseInt(document.getElementById('stabilitySlider').value);
            
            log(`ğŸ”„ Testando estabilidade com ${stabilityFrames} frames`);
            
            await initRecognizer();
            
            const response = await fetch('/api/get_gestures');
            const gestures = await response.json();
            
            if (!gestures.A) {
                log('âŒ Letra A nÃ£o disponÃ­vel');
                return;
            }
            
            // Modificar temporariamente
            const originalStability = recognizer.stabilityFrames;
            recognizer.stabilityFrames = stabilityFrames;
            recognizer.reset(); // Limpar contadores
            
            try {
                log('Simulando detecÃ§Ãµes sequenciais...');
                
                for (let frame = 1; frame <= stabilityFrames + 2; frame++) {
                    const result = await recognizer.recognizeLetter(gestures.A.landmarks);
                    
                    if (result) {
                        log(`Frame ${frame}: ${result.letter} (${(result.confidence * 100).toFixed(1)}%) - EstÃ¡vel: ${result.stable}`);
                        
                        if (result.stable) {
                            log(`âœ… Letra estabilizada no frame ${frame}!`);
                            break;
                        }
                    } else {
                        log(`Frame ${frame}: NÃ£o reconhecido`);
                    }
                }
                
            } finally {
                recognizer.stabilityFrames = originalStability;
            }
        }
        
        async function diagnoseLetterA() {
            clearOutput();
            log('ğŸ” DIAGNÃ“STICO ESPECÃFICO DA LETRA A');
            log('='.repeat(35));
            
            // Verificar se existe
            const response = await fetch('/api/get_gestures');
            const gestures = await response.json();
            
            if (!gestures.A) {
                log('âŒ PROBLEMA ENCONTRADO: Letra A nÃ£o foi capturada!');
                log('ğŸ’¡ SOLUÃ‡ÃƒO: VÃ¡ para /admin e capture a letra A');
                return;
            }
            
            const letterA = gestures.A;
            log(`âœ… Letra A encontrada:`);
            log(`   ğŸ“Š Qualidade: ${letterA.quality}%`);
            log(`   ğŸ“… Capturada: ${new Date(letterA.created_at).toLocaleString()}`);
            
            // Verificar qualidade dos landmarks
            let validLandmarks = 0;
            letterA.landmarks.forEach(point => {
                if (point.x >= 0 && point.x <= 1 && point.y >= 0 && point.y <= 1) {
                    validLandmarks++;
                }
            });
            
            log(`   ğŸ“ Landmarks vÃ¡lidos: ${validLandmarks}/21`);
            
            if (validLandmarks < 21) {
                log('âš ï¸ PROBLEMA: Alguns landmarks estÃ£o fora dos limites!');
                log('ğŸ’¡ SOLUÃ‡ÃƒO: Recapture a letra A com melhor posicionamento');
            }
            
            if (letterA.quality < 70) {
                log('âš ï¸ PROBLEMA: Qualidade baixa da captura!');
                log('ğŸ’¡ SOLUÃ‡ÃƒO: Recapture com melhor iluminaÃ§Ã£o e posiÃ§Ã£o da mÃ£o');
            }
            
            // Testar reconhecimento via API
            log('\nğŸ§ª Testando reconhecimento via API...');
            
            try {
                const apiResponse = await fetch('/api/recognize_gesture', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ landmarks: letterA.landmarks })
                });
                
                const apiResult = await apiResponse.json();
                
                if (apiResult.success && apiResult.result.letter === 'A') {
                    log(`âœ… API reconheceu corretamente: ${(apiResult.result.confidence * 100).toFixed(1)}%`);
                } else {
                    log(`âŒ API falhou: ${apiResult.error || 'NÃ£o reconhecido'}`);
                }
                
            } catch (error) {
                log(`âŒ Erro na API: ${error.message}`);
            }
            
            // Testar com reconhecedor local
            log('\nğŸ¤– Testando com reconhecedor local...');
            
            await initRecognizer();
            const localResult = await recognizer.recognizeLetter(letterA.landmarks);
            
            if (localResult && localResult.letter === 'A') {
                log(`âœ… Reconhecedor local funcionou: ${(localResult.confidence * 100).toFixed(1)}%`);
            } else {
                log(`âŒ Reconhecedor local falhou`);
                log('ğŸ’¡ Tente diminuir o threshold de confianÃ§a');
            }
        }
        
        async function testLetterAWithVariations() {
            clearOutput();
            log('ğŸ² Testando letra A com diferentes variaÃ§Ãµes...');
            
            await initRecognizer();
            
            const response = await fetch('/api/get_gestures');
            const gestures = await response.json();
            
            if (!gestures.A) {
                log('âŒ Letra A nÃ£o disponÃ­vel');
                return;
            }
            
            const variations = [
                { name: 'Landmarks originais', factor: 0 },
                { name: 'VariaÃ§Ã£o mÃ­nima (1%)', factor: 0.01 },
                { name: 'VariaÃ§Ã£o pequena (2%)', factor: 0.02 },
                { name: 'VariaÃ§Ã£o mÃ©dia (3%)', factor: 0.03 },
                { name: 'VariaÃ§Ã£o grande (5%)', factor: 0.05 }
            ];
            
            for (const variation of variations) {
                const testLandmarks = gestures.A.landmarks.map(point => ({
                    x: point.x + (Math.random() - 0.5) * variation.factor,
                    y: point.y + (Math.random() - 0.5) * variation.factor,
                    z: point.z + (Math.random() - 0.5) * variation.factor * 0.5
                }));
                
                const result = await recognizer.recognizeLetter(testLandmarks);
                
                if (result && result.letter === 'A') {
                    log(`âœ… ${variation.name}: Reconhecido (${(result.confidence * 100).toFixed(1)}%)`);
                } else if (result) {
                    log(`âš ï¸ ${variation.name}: Reconheceu '${result.letter}' (${(result.confidence * 100).toFixed(1)}%)`);
                } else {
                    log(`âŒ ${variation.name}: NÃ£o reconhecido`);
                }
            }
        }
        
        async function simulateGameScenario() {
            clearOutput();
            log('ğŸ® Simulando cenÃ¡rio real do jogo...');
            
            log('1ï¸âƒ£ Inicializando como no jogo...');
            const gameRecognizer = new CustomGestureRecognizer();
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            log('2ï¸âƒ£ Verificando gestos carregados...');
            const stats = gameRecognizer.getRecognitionStats();
            
            if (!stats.gesturesLoaded) {
                log('âŒ Gestos nÃ£o carregaram no jogo!');
                log('ğŸ’¡ Recarregue a pÃ¡gina do jogo');
                return;
            }
            
            if (!stats.availableLetters.includes('A')) {
                log('âŒ Letra A nÃ£o disponÃ­vel no jogo!');
                log('ğŸ’¡ Capture a letra A em /admin');
                return;
            }
            
            log(`âœ… ${stats.totalGestures} gestos carregados`);
            log(`ğŸ“‹ Letras: ${stats.availableLetters.join(', ')}`);
            
            log('3ï¸âƒ£ Simulando mÃºltiplas tentativas de reconhecimento...');
            
            const response = await fetch('/api/get_gestures');
            const gestures = await response.json();
            const testLandmarks = gestures.A.landmarks;
            
            let successCount = 0;
            const totalAttempts = 10;
            
            for (let i = 1; i <= totalAttempts; i++) {
                // Adicionar pequena variaÃ§Ã£o como no mundo real
                const noisyLandmarks = testLandmarks.map(point => ({
                    x: point.x + (Math.random() - 0.5) * 0.02,
                    y: point.y + (Math.random() - 0.5) * 0.02,
                    z: point.z + (Math.random() - 0.5) * 0.01
                }));
                
                const result = await gameRecognizer.recognizeLetter(noisyLandmarks);
                
                if (result && result.letter === 'A' && result.stable) {
                    successCount++;
                    log(`âœ… Tentativa ${i}: SUCESSO (${(result.confidence * 100).toFixed(1)}%)`);
                } else if (result && result.letter === 'A') {
                    log(`ğŸŸ¡ Tentativa ${i}: Detectado mas nÃ£o estÃ¡vel (${(result.confidence * 100).toFixed(1)}%)`);
                } else if (result) {
                    log(`âŒ Tentativa ${i}: Reconheceu '${result.letter}' (${(result.confidence * 100).toFixed(1)}%)`);
                } else {
                    log(`âŒ Tentativa ${i}: NÃ£o reconhecido`);
                }
                
                // Pequena pausa entre tentativas
                await new Promise(resolve => setTimeout(resolve, 50));
            }
            
            const successRate = (successCount / totalAttempts) * 100;
            log(`\nğŸ“Š RESULTADO FINAL:`);
            log(`   Taxa de sucesso: ${successRate.toFixed(1)}% (${successCount}/${totalAttempts})`);
            
            if (successRate >= 70) {
                log(`âœ… Excelente! O sistema deve funcionar bem no jogo.`);
            } else if (successRate >= 40) {
                log(`âš ï¸ Funcionamento parcial. Considere ajustar threshold ou recapturar.`);
            } else {
                log(`âŒ Taxa muito baixa. Sistema precisa de ajustes.`);
                log(`ğŸ’¡ SugestÃµes:`);
                log(`   - Diminuir threshold para 60-65%`);
                log(`   - Recapturar letra A com melhor qualidade`);
                log(`   - Verificar se MediaPipe estÃ¡ funcionando corretamente`);
            }
        }
    </script>
</body>
</html>